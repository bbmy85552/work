<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êï∞ÂÄºËΩ¨Êç¢Êú∫ - ÁÅµÊ¥ªÊãñÊãΩÁâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 800px;
            width: 100%;
            min-height: 700px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-content {
            padding: 40px;
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2.2em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .input-section, .output-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .input-section:focus-within, .output-section:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 10px;
            border-radius: 2px;
        }

        /* Êï∞Â≠óËæìÂÖ•ÁªÑ‰ª∂ */
        .number-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .arrow-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
        }

        .arrow-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .arrow-btn:active {
            transform: scale(0.95);
        }

        .arrow-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .number-display {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 2em;
            font-weight: 700;
            color: #333;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .number-display:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-hint {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .variable-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        
        /* ÂèØÊãñÊãΩÊ≠•È™§Âå∫Âüü */
        .steps-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px dashed #e1e5e9;
            min-height: 300px;
            position: relative;
            transition: all 0.3s ease;
        }

        .steps-container.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .steps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .steps-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .step-counter {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .steps-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 200px;
            padding: 10px;
        }

        .step-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .step-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-operator {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            min-width: 30px;
            text-align: center;
        }

        .step-value {
            font-size: 1.2em;
            font-weight: 500;
            color: #333;
        }

        .step-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2em;
        }

        .step-remove:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .empty-steps {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
            font-size: 1.1em;
        }

        .empty-steps::before {
            content: 'üìã';
            display: block;
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Âø´ÈÄüÊìç‰ΩúÂå∫Âüü */
        .quick-operations {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e1e5e9;
        }

        .operations-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .operation-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .op-btn {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px 10px;
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .op-btn:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .op-btn:active {
            transform: translateY(0);
        }

        .value-input-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e1e5e9;
        }

        .value-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            font-weight: 500;
        }

        .value-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-step-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-step-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .add-step-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* ÈöèÊú∫Êï∞Â≠óÊåâÈíÆ */
        .random-btn {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .random-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        /* ËØ≠Èü≥Êí≠Êä•ÊåâÈíÆ */
        .voice-btn {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);
        }

        .voice-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(250, 112, 154, 0.4);
        }

        .voice-btn.speaking {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        
        /* ÊéßÂà∂ÊåâÈíÆ */
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .control-btn.secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .control-btn.secondary:hover:not(:disabled) {
            border-color: #667eea;
            background: white;
        }

        .control-btn:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ÁªìÊûúÊòæÁ§∫ */
        .result-display {
            font-size: 2em;
            font-weight: 700;
            color: #333;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e1e5e9;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .result-display.calculating {
            animation: calculating 1s infinite;
        }

        @keyframes calculating {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-input-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .modal-arrow {
            width: 40px;
            height: 40px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        .modal-arrow:hover {
            background: #667eea;
            color: white;
        }

        .modal-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1.2em;
            text-align: center;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn.secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .modal-btn:hover {
            transform: translateY(-1px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            animation: shake 0.5s ease;
            font-size: 0.9em;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* ÂèòÈáèËæìÂÖ•Ê†∑Âºè */
        .variable-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .variable-label {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
            min-width: 60px;
        }

        .variable-value-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .variable-value-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .variable-value-input.has-value {
            border-color: #28a745;
            background: #f8fff9;
        }

        .variable-hint {
            font-size: 0.85em;
            color: #666;
            text-align: center;
        }

        .variable-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .variable-status.set {
            background: #d4edda;
            color: #155724;
        }

        .variable-status.unset {
            background: #fff3cd;
            color: #856404;
        }

  
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .main-container {
                max-width: 100%;
            }

            .main-content {
                padding: 20px;
            }

            .operation-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .number-display {
                font-size: 1.5em;
                min-width: 120px;
            }

            .value-input-section {
                flex-direction: column;
                gap: 10px;
            }

            .add-step-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="main-content">
            <h1>Êï∞ÂÄºËΩ¨Êç¢Êú∫</h1>

            <!-- ËæìÂÖ•Âå∫ -->
            <div class="input-section">
                <div class="section-title">
                    ÂàùÂßãÂÄºËÆæÁΩÆ
                    <span class="variable-badge" id="inputTypeBadge" style="display: none;">ÂèòÈáè</span>
                </div>
                <div class="number-input-container">
                    <button class="arrow-btn" onclick="adjustValue(-1)" id="leftArrow">‚àí</button>
                    <div class="number-display" contenteditable="true" id="initialValue" placeholder="0">0</div>
                    <button class="arrow-btn" onclick="adjustValue(1)" id="rightArrow">+</button>
                </div>
                <div class="input-hint" id="inputHint">
                    ÊîØÊåÅÊï∞Â≠ó„ÄÅË¥üÊï∞„ÄÅÂàÜÊï∞ÔºàÂ¶Ç -5, 1/2, -3/4ÔºâÊàñÂèòÈáèÔºàÂ¶Ç a, xÔºâ
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="random-btn" onclick="generateRandomNumber()">
                        üé≤ ÈöèÊú∫Êï∞Â≠ó
                    </button>
                </div>
            </div>

            <!-- Âø´ÈÄüÊìç‰ΩúÂå∫Âüü -->
            <div class="quick-operations">
                <div class="operations-title">ÈÄâÊã©ËøêÁÆó</div>
                <div class="operation-buttons">
                    <button class="op-btn" data-operation="add" onclick="selectOperation('add')">+</button>
                    <button class="op-btn" data-operation="subtract" onclick="selectOperation('subtract')">‚àí</button>
                    <button class="op-btn" data-operation="multiply" onclick="selectOperation('multiply')">√ó</button>
                    <button class="op-btn" data-operation="divide" onclick="selectOperation('divide')">√∑</button>
                </div>
                <div class="value-input-section">
                    <input type="text" class="value-input" id="quickValueInput" placeholder="ËæìÂÖ•Êï∞Â≠óÊàñÂèòÈáè" value="1">
                    <button class="add-step-btn" onclick="quickAddStep()" id="quickAddBtn" disabled>Ê∑ªÂä†Ê≠•È™§</button>
                </div>
            </div>

            <!-- ÂèØÊãñÊãΩÊ≠•È™§Âå∫Âüü -->
            <div class="steps-container" id="stepsContainer">
                <div class="steps-header">
                    <div class="steps-title">ËøêÁÆóÊ≠•È™§</div>
                    <div class="step-counter" id="stepCounter">0 ‰∏™Ê≠•È™§</div>
                </div>
                <div class="steps-list" id="stepsList">
                    <div class="empty-steps">ÁÇπÂáª‰∏äÊñπËøêÁÆóÊåâÈíÆÊ∑ªÂä†Ê≠•È™§</div>
                </div>
            </div>

            <!-- ÊéßÂà∂ÊåâÈíÆ -->
            <div class="control-buttons">
                <button class="control-btn secondary" onclick="clearAllSteps()">
                    Ê∏ÖÁ©∫Ê≠•È™§
                </button>
                <button class="control-btn secondary" onclick="showVariableModal()" id="variableBtn" style="display: none;">
                    ËÆæÁΩÆÂèòÈáèÂÄº
                </button>
                <button class="control-btn primary" onclick="calculateResult()" id="calculateBtn" disabled>
                    ËÆ°ÁÆóÁªìÊûú
                </button>
                <button class="control-btn voice-btn" onclick="speakResult()" id="voiceBtn" disabled>
                    üîä ËØ≠Èü≥Êí≠Êä•
                </button>
            </div>

            <!-- ËæìÂá∫Âå∫ -->
            <div class="output-section">
                <div class="section-title">ËÆ°ÁÆóÁªìÊûú</div>
                <div class="result-display" id="outputResult">
                    <span style="color: #999;">Á≠âÂæÖËÆ°ÁÆóÁªìÊûú...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="operationModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ËØ∑ËæìÂÖ•Êìç‰ΩúÊï∞</div>
            <div class="modal-input-container">
                <button class="modal-arrow" onclick="adjustModalValue(-1)" id="modalLeftArrow">‚àí</button>
                <input type="text" class="modal-input" id="modalInput" placeholder="ËæìÂÖ•Êï∞Â≠óÊàñÂèòÈáè" value="0">
                <button class="modal-arrow" onclick="adjustModalValue(1)" id="modalRightArrow">+</button>
            </div>
            <div style="text-align: center; color: #666; font-size: 0.9em; margin-top: 10px;">
                ÊîØÊåÅÊï∞Â≠ó„ÄÅË¥üÊï∞„ÄÅÂàÜÊï∞ÔºàÂ¶Ç -5, 1/2, -3/4ÔºâÊàñÂèòÈáèÔºàÂ¶Ç a, xÔºâ
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="modal-btn primary" onclick="confirmOperation()">Á°ÆËÆ§</button>
            </div>
            <div id="modalError"></div>
        </div>
    </div>

    <!-- ÂèòÈáèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="variableModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-title">ËÆæÁΩÆÂèòÈáèÂÄº</div>
            <div style="margin-bottom: 20px; color: #666;">
                ‰∏∫Ë°®ËææÂºè‰∏≠Âá∫Áé∞ÁöÑÂèòÈáèËÆæÁΩÆÂÖ∑‰ΩìÊï∞ÂÄºÔºåÁïôÁ©∫Âàô‰øùÊåÅÂèòÈáèÂΩ¢Âºè
            </div>
            <div id="variableInputs" style="max-height: 400px; overflow-y: auto;">
                <!-- ÂèòÈáèËæìÂÖ•Â∞ÜÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="clearVariableValues()">Ê∏ÖÁ©∫ÊâÄÊúâ</button>
                <button class="modal-btn secondary" onclick="closeVariableModal()">ÂèñÊ∂à</button>
                <button class="modal-btn primary" onclick="confirmVariableValues()">Á°ÆËÆ§</button>
            </div>
            <div id="variableError"></div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
        const state = {
            initialValue: 0,
            initialOriginalValue: '0',
            initialValueType: 'number', // 'number' Êàñ 'variable'
            steps: [],
            selectedOperation: null, // ÂΩìÂâçÈÄâÊã©ÁöÑËøêÁÆóÊìç‰Ωú
            currentDraggedOperation: null,
            pendingStepIndex: null,
            variableValues: {}, // Â≠òÂÇ®ÂèòÈáèÂÄºÁöÑÊò†Â∞Ñ {variableName: {value: number/fraction, type: 'number'/'fraction', originalValue: string}}
            lastCalculationResult: null // Â≠òÂÇ®ÊúÄÂêéÁöÑËÆ°ÁÆóÁªìÊûúÁî®‰∫éËØ≠Èü≥Êí≠Êä•
        };

        // ËæÖÂä©ÂáΩÊï∞ÔºöÊ£ÄÊµãÊòØÂê¶‰∏∫ÂèòÈáè
        function isVariable(value) {
            return /^[a-zA-Z][a-zA-Z0-9]*$/.test(value.trim());
        }

        // Êî∂ÈõÜË°®ËææÂºè‰∏≠ÊâÄÊúâÁöÑÂèòÈáè
        function collectVariables() {
            const variables = new Set();

            // Ê£ÄÊü•ÂàùÂßãÂÄºÊòØÂê¶‰∏∫ÂèòÈáè
            if (state.initialValueType === 'variable') {
                variables.add(state.initialValue);
            }

            // Ê£ÄÊü•ÊØè‰∏™Ê≠•È™§‰∏≠ÁöÑÂèòÈáè
            state.steps.forEach(step => {
                if (step.valueType === 'variable') {
                    variables.add(step.value);
                }
            });

            return Array.from(variables).sort();
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöÊ£ÄÊµãÊòØÂê¶‰∏∫Êï∞Â≠óÔºàÊîØÊåÅË¥üÂè∑„ÄÅÂ∞èÊï∞„ÄÅÂàÜÊï∞Ôºâ
        function isNumber(value) {
            const trimmedValue = value.trim();

            // ÊîØÊåÅË¥üÂè∑ÂíåÂ∞èÊï∞
            if (!isNaN(parseFloat(trimmedValue)) && isFinite(parseFloat(trimmedValue))) {
                return true;
            }

            // ÊîØÊåÅÂàÜÊï∞Ê†ºÂºè (Â¶Ç 1/2, 3/4)
            if (/^-?\d+\/-?\d+$/.test(trimmedValue)) {
                return true;
            }

            return false;
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöËß£ÊûêÊï∞ÂÄºÊàñÂèòÈáè
        function parseValue(value) {
            const trimmedValue = value.trim();

            if (isVariable(trimmedValue)) {
                return { type: 'variable', value: trimmedValue };
            } else if (isNumber(trimmedValue)) {
                let originalValue = trimmedValue;

                // Â§ÑÁêÜÂàÜÊï∞ - ‰øùÊåÅÂàÜÊï∞ÂΩ¢Âºè‰∏çËΩ¨Êç¢‰∏∫Â∞èÊï∞
                if (/^-?\d+\/-?\d+$/.test(trimmedValue)) {
                    const parts = trimmedValue.split('/');
                    let numerator = parseInt(parts[0]);
                    let denominator = parseInt(parts[1]);

                    // Á°Æ‰øùÂàÜÊØç‰∏ç‰∏∫Èõ∂
                    if (denominator === 0) {
                        return { type: 'invalid', value: trimmedValue };
                    }

                    // Â¶ÇÊûúÂàÜÊØç‰∏∫Ë¥üÊï∞ÔºåÂ∞ÜË¥üÂè∑ÁßªÂà∞ÂàÜÂ≠ê
                    if (denominator < 0) {
                        numerator = -numerator;
                        denominator = -denominator;
                    }

                    return { type: 'fraction', numerator: numerator, denominator: denominator, originalValue: originalValue };
                } else {
                    const numericValue = parseFloat(trimmedValue);
                    return { type: 'number', value: numericValue, originalValue: originalValue };
                }
            } else {
                return { type: 'invalid', value: trimmedValue };
            }
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöÂà§Êñ≠ÂÄºÊòØÂê¶‰∏∫Ë¥üÊï∞
        function isNegativeValue(value, type) {
            if (type === 'number') {
                return typeof value === 'number' && value < 0;
            } else if (type === 'fraction') {
                return value && value.numerator && value.numerator < 0;
            } else if (type === 'variable') {
                return false; // ÂèòÈáèÊú¨Ë∫´‰∏çÂà§Êñ≠‰∏∫Ë¥üÊï∞
            } else {
                // ÂØπ‰∫éÂ≠óÁ¨¶‰∏≤ÂΩ¢ÂºèÁöÑÂÄº
                const strValue = value.toString().trim();
                return strValue.startsWith('-') && strValue !== '-';
            }
        }

        // ÂàÜÊï∞ËøêÁÆóÊ†∏ÂøÉÂáΩÊï∞
        // ËÆ°ÁÆóÊúÄÂ§ßÂÖ¨Á∫¶Êï∞ (GCD)
        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b !== 0) {
                const temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        // ËÆ°ÁÆóÊúÄÂ∞èÂÖ¨ÂÄçÊï∞ (LCM)
        function lcm(a, b) {
            return Math.abs(a * b) / gcd(a, b);
        }

        // ÂàÜÊï∞ÂåñÁÆÄ
        function simplifyFraction(numerator, denominator) {
            if (denominator === 0) {
                throw new Error("ÂàÜÊØç‰∏çËÉΩ‰∏∫Èõ∂");
            }

            // Â§ÑÁêÜË¥üÊï∞
            if (denominator < 0) {
                numerator = -numerator;
                denominator = -denominator;
            }

            // Â¶ÇÊûúÂàÜÂ≠ê‰∏∫0ÔºåËøîÂõû 0/1
            if (numerator === 0) {
                return { numerator: 0, denominator: 1 };
            }

            // ÂåñÁÆÄÂàÜÊï∞
            const commonDivisor = gcd(numerator, denominator);
            return {
                numerator: numerator / commonDivisor,
                denominator: denominator / commonDivisor
            };
        }

        // ÂàÜÊï∞Âä†Ê≥ï
        function addFractions(frac1, frac2) {
            const commonDenominator = lcm(frac1.denominator, frac2.denominator);
            const newNumerator = frac1.numerator * (commonDenominator / frac1.denominator) +
                               frac2.numerator * (commonDenominator / frac2.denominator);
            return simplifyFraction(newNumerator, commonDenominator);
        }

        // ÂàÜÊï∞ÂáèÊ≥ï
        function subtractFractions(frac1, frac2) {
            const commonDenominator = lcm(frac1.denominator, frac2.denominator);
            const newNumerator = frac1.numerator * (commonDenominator / frac1.denominator) -
                               frac2.numerator * (commonDenominator / frac2.denominator);
            return simplifyFraction(newNumerator, commonDenominator);
        }

        // ÂàÜÊï∞‰πòÊ≥ï
        function multiplyFractions(frac1, frac2) {
            const newNumerator = frac1.numerator * frac2.numerator;
            const newDenominator = frac1.denominator * frac2.denominator;
            return simplifyFraction(newNumerator, newDenominator);
        }

        // ÂàÜÊï∞Èô§Ê≥ï
        function divideFractions(frac1, frac2) {
            if (frac2.numerator === 0) {
                throw new Error("Èô§Êï∞‰∏çËÉΩ‰∏∫Èõ∂");
            }
            const newNumerator = frac1.numerator * frac2.denominator;
            const newDenominator = frac1.denominator * frac2.numerator;
            return simplifyFraction(newNumerator, newDenominator);
        }

        // Êï∞Â≠óËΩ¨ÂàÜÊï∞ÔºàÂ∞ÜÂ∞èÊï∞ËΩ¨Êç¢‰∏∫ÂàÜÊï∞Ôºâ
        function decimalToFraction(decimal) {
            const tolerance = 1e-10;
            const maxDenominator = 1000;

            if (Math.abs(decimal) < tolerance) {
                return { numerator: 0, denominator: 1 };
            }

            let numerator = 1;
            let denominator = 1;

            // ÂØπ‰∫éÊï¥Êï∞
            if (Number.isInteger(decimal)) {
                return { numerator: decimal, denominator: 1 };
            }

            // ËøûÂàÜÊï∞ÈÄºËøë
            let h1 = 1, h2 = 0, k1 = 0, k2 = 1;
            let b = decimal;

            do {
                const a = Math.floor(b);
                const aux = h1;
                h1 = a * h1 + h2;
                h2 = aux;
                const aux2 = k1;
                k1 = a * k1 + k2;
                k2 = aux2;

                if (Math.abs(b - a) < tolerance) break;
                b = 1 / (b - a);

            } while (Math.abs(k1) <= maxDenominator && Math.abs(decimal - h1/k1) > tolerance);

            return simplifyFraction(h1, k1);
        }

        // Ê†ºÂºèÂåñÂàÜÊï∞ÊòæÁ§∫
        function formatFraction(numerator, denominator) {
            const simplified = simplifyFraction(numerator, denominator);

            // Â¶ÇÊûúÂàÜÊØç‰∏∫1ÔºåÊòæÁ§∫‰∏∫Êï¥Êï∞
            if (simplified.denominator === 1) {
                return simplified.numerator.toString();
            }

            // ÂØπ‰∫éÂàù‰∏≠Êï∞Â≠¶ÊïôÂ≠¶ÔºåÂßãÁªàÊòæÁ§∫‰∏∫ÂÅáÂàÜÊï∞ÂΩ¢ÂºèÔºå‰∏çËΩ¨Êç¢‰∏∫Â∏¶ÂàÜÊï∞
            // ËøôÊ†∑ËÉΩ‰øùÊåÅËøêÁÆóÁöÑÁ≤æÁ°ÆÊÄßÂíåÊïôÂ≠¶ÁöÑ‰∏ÄËá¥ÊÄß
            return `${simplified.numerator}/${simplified.denominator}`;
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöÊ†ºÂºèÂåñÊï∞ÂÄºÊòæÁ§∫ÔºàÊîØÊåÅÂàÜÊï∞Ôºâ
        function formatNumber(value) {
            if (typeof value !== 'number') return value;

            // ÂØπ‰∫éÊï¥Êï∞ÔºåÁõ¥Êé•ËøîÂõû
            if (Number.isInteger(value)) {
                return value.toString();
            }

            // ÂØπ‰∫éÂ∞èÊï∞Ôºå‰ºòÂÖàÊòæÁ§∫‰∏∫Â∞èÊï∞Ê†ºÂºèÔºåÂè™ÊúâÁúüÊ≠£ÁöÑÁÆÄÂçïÂàÜÊï∞ÊâçÊòæÁ§∫‰∏∫ÂàÜÊï∞
            const tolerance = 1e-10;

            // Ê£ÄÊü•Â∏∏ËßÅÁöÑÁÆÄÂçïÂàÜÊï∞Ôºà1/2, 1/3, 2/3, 1/4, 3/4Á≠âÔºâ
            const commonFractions = [
                {num: 1, den: 2}, {num: 1, den: 3}, {num: 2, den: 3},
                {num: 1, den: 4}, {num: 3, den: 4}, {num: 1, den: 5},
                {num: 2, den: 5}, {num: 3, den: 5}, {num: 4, den: 5}
            ];

            for (let fraction of commonFractions) {
                const fractionValue = fraction.num / fraction.den;
                if (Math.abs(value - fractionValue) < tolerance) {
                    return `${fraction.num}/${fraction.den}`;
                }
                if (Math.abs(value + fractionValue) < tolerance) {
                    return `-${fraction.num}/${fraction.den}`;
                }
            }

            // ÂÖ∂‰ªñÊÉÖÂÜµÊòæÁ§∫‰∏∫Â∞èÊï∞
            return value.toFixed(4).replace(/\.?0+$/, '');
        }

        // ÂàùÂßãÂåñÊñ∞ÂäüËÉΩ
        function initQuickOperations() {
            // ‰∏∫Âø´ÈÄüËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            const quickValueInput = document.getElementById('quickValueInput');

            quickValueInput.addEventListener('input', function() {
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËæìÂÖ•È™åËØÅÈÄªËæë
            });

            quickValueInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    quickAddStep();
                }
            });

            // ÂàùÂßãÂåñÊ∑ªÂä†ÊåâÈíÆÁä∂ÊÄÅ
            updateAddButtonState();
        }

        // Êìç‰ΩúÊãñÊãΩÂºÄÂßã
        function handleDragStart(e) {
            // Á°Æ‰øùËé∑ÂèñÂà∞Ê≠£Á°ÆÁöÑÊìç‰ΩúÂç°Áâá
            const card = e.target.closest('.operation-card');
            if (card) {
                state.currentDraggedOperation = {
                    operation: card.dataset.operation,
                    name: card.dataset.name
                };
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'copy';
                            }
        }

        // Êìç‰ΩúÊãñÊãΩÁªìÊùü
        function handleDragEnd(e) {
            const card = e.target.closest('.operation-card');
            if (card) {
                card.classList.remove('dragging');
            }
                        // ‰∏çÂú®ËøôÈáåÊ∏ÖÁêÜÁä∂ÊÄÅÔºåËÆ©drop‰∫ã‰ª∂Â§ÑÁêÜÂêéÂÜçÊ∏ÖÁêÜ
        }

        // ÊãñÊãΩÁªèËøá
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            document.getElementById('stepsContainer').classList.add('drag-over');
        }

        // ÊãñÊãΩÁ¶ªÂºÄ
        function handleDragLeave(e) {
            if (e.target.id === 'stepsContainer') {
                document.getElementById('stepsContainer').classList.remove('drag-over');
            }
        }

        // ÊîæÁΩÆ
        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('stepsContainer').classList.remove('drag-over');

            // Â§ÑÁêÜÊãñÊãΩÁöÑÊìç‰Ωú
            if (state.currentDraggedOperation) {
                showOperationModal(state.currentDraggedOperation);
            }
        }

        // Êõ¥Êñ∞ËæìÂÖ•Á±ªÂûãÊòæÁ§∫
        function updateInputType(value) {
            const parsed = parseValue(value);
            const badge = document.getElementById('inputTypeBadge');
            const hint = document.getElementById('inputHint');
            const leftArrow = document.getElementById('leftArrow');
            const rightArrow = document.getElementById('rightArrow');

            if (parsed.type === 'variable') {
                badge.style.display = 'inline-block';
                badge.textContent = parsed.value;
                hint.textContent = 'ÂèòÈáèÊ®°ÂºèÔºöÁõ¥Êé•ÁºñËæëÂèòÈáèÂêç';
                leftArrow.disabled = true;
                rightArrow.disabled = true;
                state.initialValueType = 'variable';
                state.initialValue = parsed.value;
                state.initialOriginalValue = parsed.value;
            } else if (parsed.type === 'number') {
                badge.style.display = 'none';
                hint.textContent = 'Êï∞Â≠óÊ®°ÂºèÔºöÁõ¥Êé•ËæìÂÖ•Êï∞Â≠óÊàñ‰ΩøÁî®ÁÆ≠Â§¥Ë∞ÉËäÇ';
                leftArrow.disabled = false;
                rightArrow.disabled = false;
                state.initialValueType = 'number';
                state.initialValue = parsed.value;
                state.initialOriginalValue = parsed.originalValue || parsed.value;
            } else if (parsed.type === 'fraction') {
                badge.style.display = 'inline-block';
                badge.textContent = 'ÂàÜÊï∞';
                hint.textContent = 'ÂàÜÊï∞Ê®°ÂºèÔºöÂàÜÊï∞Â∞Ü‰øùÊåÅÁ≤æÁ°ÆËÆ°ÁÆó';
                leftArrow.disabled = true;
                rightArrow.disabled = true;
                state.initialValueType = 'fraction';
                state.initialValue = parsed;
                // Á°Æ‰øù originalValue Ê≠£Á°Æ‰øùÂ≠ò
                state.initialOriginalValue = parsed.originalValue || `${parsed.numerator}/${parsed.denominator}`;
            } else {
                badge.style.display = 'none';
                hint.textContent = 'Êó†ÊïàËæìÂÖ•ÔºåËØ∑ËæìÂÖ•Êï∞Â≠ó„ÄÅÂàÜÊï∞ÊàñÂèòÈáèÂêç';
                leftArrow.disabled = true;
                rightArrow.disabled = true;
                state.initialValueType = 'invalid';
                state.initialValue = 0;
                state.initialOriginalValue = '0';
            }

            // Êõ¥Êñ∞ÂèòÈáèÊåâÈíÆÁä∂ÊÄÅ
            updateVariableButton();
        }

        // Ë∞ÉËäÇÂàùÂßãÂÄº
        function adjustValue(delta) {
            if (state.initialValueType !== 'number') return;

            const display = document.getElementById('initialValue');
            const currentValue = parseFloat(display.textContent) || 0;
            const newValue = currentValue + delta;
            display.textContent = newValue;
            state.initialValue = newValue;
        }

        // ÁîüÊàêÈöèÊú∫Êï∞Â≠ó
        function generateRandomNumber() {
            const min = -10;
            const max = 10;
            const randomNum = Math.floor(Math.random() * (max - min + 1)) + min;

            const display = document.getElementById('initialValue');
            display.textContent = randomNum;
            updateInputType(randomNum.toString());

            // Ê∑ªÂä†ÁîüÊàêÂä®ÁîªÊïàÊûú
            display.style.animation = 'none';
            setTimeout(() => {
                display.style.animation = 'pulse 0.5s ease';
            }, 10);
        }

        // ÁõëÂê¨ÂàùÂßãÂÄºËæìÂÖ•
        document.getElementById('initialValue').addEventListener('input', function(e) {
            updateInputType(e.target.textContent);
        });

        // Â§ÑÁêÜÁÑ¶ÁÇπ‰∫ã‰ª∂
        document.getElementById('initialValue').addEventListener('focus', function(e) {
            if (e.target.textContent === '0') {
                e.target.textContent = '';
            }
        });

        document.getElementById('initialValue').addEventListener('blur', function(e) {
            if (e.target.textContent.trim() === '') {
                e.target.textContent = '0';
                updateInputType('0');
            }
        });

        // ÊòæÁ§∫Êìç‰ΩúÊ®°ÊÄÅÊ°Ü
        function showOperationModal(operation) {
            const modal = document.getElementById('operationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalInput = document.getElementById('modalInput');

            modalTitle.textContent = `${operation.name} - ËØ∑ËæìÂÖ•Êìç‰ΩúÊï∞`;
            modalInput.value = '0';
            modalInput.focus();
            modalInput.select();

            // Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØ‰ø°ÊÅØ
            document.getElementById('modalError').innerHTML = '';

            modal.classList.add('show');
            state.currentDraggedOperation = operation;
        }

        // ÊòæÁ§∫ÂèòÈáèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function showVariableModal() {
            const variables = collectVariables();
            if (variables.length === 0) {
                showError('ÂΩìÂâçË°®ËææÂºè‰∏≠Ê≤°ÊúâÂèòÈáèÔºÅ');
                return;
            }

            const modal = document.getElementById('variableModal');
            const variableInputs = document.getElementById('variableInputs');

            // ÁîüÊàêÂèòÈáèËæìÂÖ•ÁïåÈù¢
            variableInputs.innerHTML = variables.map(variable => {
                const savedValue = state.variableValues[variable];
                const inputValue = savedValue ? savedValue.originalValue : '';
                const hasValue = inputValue !== '';

                return `
                    <div class="variable-input-group">
                        <div class="variable-label">${variable} =</div>
                        <input type="text"
                               class="variable-value-input ${hasValue ? 'has-value' : ''}"
                               id="var_${variable}"
                               placeholder="ËæìÂÖ•Êï∞ÂÄºÊàñÁïôÁ©∫"
                               value="${inputValue}"
                               data-variable="${variable}">
                        <div class="variable-status ${hasValue ? 'set' : 'unset'}">
                            ${hasValue ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ'}
                        </div>
                    </div>
                    <div class="variable-hint">ÊîØÊåÅÊï∞Â≠ó„ÄÅË¥üÊï∞„ÄÅÂàÜÊï∞ÔºàÂ¶Ç -5, 1/2, -3/4Ôºâ</div>
                `;
            }).join('');

            // Ê∑ªÂä†ËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨
            variables.forEach(variable => {
                const input = document.getElementById(`var_${variable}`);
                const status = input.nextElementSibling;

                input.addEventListener('input', function() {
                    const hasValue = this.value.trim() !== '';
                    this.classList.toggle('has-value', hasValue);
                    status.className = `variable-status ${hasValue ? 'set' : 'unset'}`;
                    status.textContent = hasValue ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ';
                });
            });

            // Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
            document.getElementById('variableError').innerHTML = '';

            modal.classList.add('show');
        }

        // ÂÖ≥Èó≠ÂèòÈáèÊ®°ÊÄÅÊ°Ü
        function closeVariableModal() {
            const modal = document.getElementById('variableModal');
            modal.classList.remove('show');
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÂèòÈáèÂÄº
        function clearVariableValues() {
            const variables = collectVariables();
            variables.forEach(variable => {
                const input = document.getElementById(`var_${variable}`);
                const status = input.nextElementSibling;

                if (input) {
                    input.value = '';
                    input.classList.remove('has-value');
                    status.className = 'variable-status unset';
                    status.textContent = 'Êú™ËÆæÁΩÆ';
                }
            });
        }

        // Á°ÆËÆ§ÂèòÈáèÂÄºËÆæÁΩÆ
        function confirmVariableValues() {
            const variables = collectVariables();
            const newVariableValues = {};
            let hasError = false;

            // È™åËØÅÂπ∂Êî∂ÈõÜÂèòÈáèÂÄº
            for (let variable of variables) {
                const input = document.getElementById(`var_${variable}`);
                const value = input.value.trim();

                if (value === '') {
                    // ÁïôÁ©∫Âàô‰øùÊåÅ‰∏∫ÂèòÈáè
                    delete newVariableValues[variable];
                    continue;
                }

                const parsed = parseValue(value);
                if (parsed.type === 'invalid') {
                    document.getElementById('variableError').innerHTML =
                        `<div class="error-message">ÂèòÈáè ${variable} ÁöÑÂÄºÊó†ÊïàÔºÅËØ∑ËæìÂÖ•Êï∞Â≠óÊàñÂàÜÊï∞„ÄÇ</div>`;
                    hasError = true;
                    break;
                }

                // Â≠òÂÇ®ÂèòÈáèÂÄº
                if (parsed.type === 'fraction') {
                    newVariableValues[variable] = {
                        numerator: parsed.numerator,
                        denominator: parsed.denominator,
                        type: 'fraction',
                        originalValue: parsed.originalValue
                    };
                } else if (parsed.type === 'number') {
                    newVariableValues[variable] = {
                        value: parsed.value,
                        type: 'number',
                        originalValue: parsed.originalValue
                    };
                }
            }

            if (hasError) return;

            // Êõ¥Êñ∞Áä∂ÊÄÅ
            state.variableValues = newVariableValues;
            closeVariableModal();

            // Â¶ÇÊûúÊúâÊ≠•È™§‰∏îÊâÄÊúâÂèòÈáèÈÉΩÂ∑≤ËÆæÁΩÆÂÄºÔºåËá™Âä®ËÆ°ÁÆóÁªìÊûú
            if (state.steps.length > 0 && Object.keys(newVariableValues).length === variables.length) {
                calculateResult();
            }
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            const modal = document.getElementById('operationModal');
            modal.classList.remove('show');
                        state.currentDraggedOperation = null;
            state.pendingStepIndex = null;
        }

        // Ë∞ÉËäÇÊ®°ÊÄÅÊ°Ü‰∏≠ÁöÑÂÄº
        function adjustModalValue(delta) {
            const input = document.getElementById('modalInput');
            const parsed = parseValue(input.value);

            if (parsed.type === 'number') {
                const newValue = parsed.value + delta;
                input.value = newValue;
            }
        }

        // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜËæìÂÖ•Á±ªÂûã
        function updateModalInputType() {
            const input = document.getElementById('modalInput');
            const leftArrow = document.getElementById('modalLeftArrow');
            const rightArrow = document.getElementById('modalRightArrow');
            const parsed = parseValue(input.value);

            if (parsed.type === 'number') {
                leftArrow.disabled = false;
                rightArrow.disabled = false;
            } else {
                leftArrow.disabled = true;
                rightArrow.disabled = true;
            }
        }

        // Á°ÆËÆ§Êìç‰Ωú
        function confirmOperation() {
            const modalInput = document.getElementById('modalInput');
            const modalError = document.getElementById('modalError');
            const value = modalInput.value.trim();

            if (!value) {
                modalError.innerHTML = '<div class="error-message">ËØ∑ËæìÂÖ•Êï∞Â≠óÊàñÂèòÈáèÂêçÔºÅ</div>';
                return;
            }

            const parsed = parseValue(value);

            if (parsed.type === 'invalid') {
                modalError.innerHTML = '<div class="error-message">Êó†ÊïàËæìÂÖ•ÔºÅËØ∑ËæìÂÖ•Êï∞Â≠óÊàñÊúâÊïàÁöÑÂèòÈáèÂêç„ÄÇ</div>';
                return;
            }

            // È™åËØÅÈô§Ê≥ï
            if (state.currentDraggedOperation && state.currentDraggedOperation.operation === 'divide') {
                let isZero = false;

                if (parsed.type === 'number' && parsed.value === 0) {
                    isZero = true;
                } else if (parsed.type === 'fraction' && parsed.numerator === 0) {
                    isZero = true;
                }

                if (isZero) {
                    modalError.innerHTML = '<div class="error-message">Èô§Êï∞‰∏çËÉΩ‰∏∫Èõ∂ÔºÅ</div>';
                    return;
                }
            }

            // Á°Æ‰øùÊúâÊúâÊïàÁöÑÊìç‰Ωú
            if (!state.currentDraggedOperation) {
                modalError.innerHTML = '<div class="error-message">Êìç‰ΩúÈîôËØØÔºåËØ∑ÈáçÊñ∞Êìç‰ΩúÔºÅ</div>';
                return;
            }

            // Ê∑ªÂä†Ê≠•È™§
            addStep(state.currentDraggedOperation, parsed);
            closeModal();
        }

        // Ê∑ªÂä†Ê≠•È™§
        function addStep(operation, parsedValue) {
            let stepValue;

            // Ê†πÊçÆÁ±ªÂûãÂ§ÑÁêÜÂÄºÁöÑÂ≠òÂÇ®
            if (parsedValue.type === 'fraction') {
                stepValue = {
                    numerator: parsedValue.numerator,
                    denominator: parsedValue.denominator
                };
            } else {
                stepValue = parsedValue.value;
            }

            const step = {
                id: Date.now(),
                operation: operation.operation,
                name: operation.name,
                value: stepValue,
                valueType: parsedValue.type,
                originalValue: parsedValue.originalValue,
                operator: getOperatorSymbol(operation.operation)
            };

            state.steps.push(step);
            renderSteps();
            updateStepCounter();
            updateCalculateButton();
            updateVariableButton();
            updateVoiceButton(); // Ê∑ªÂä†Ê≠•È™§Êó∂Êõ¥Êñ∞ËØ≠Èü≥ÊåâÈíÆÁä∂ÊÄÅ
        }

        // Ëé∑ÂèñËøêÁÆóÁ¨¶Á¨¶Âè∑
        function getOperatorSymbol(operation) {
            const symbols = {
                'add': '+',
                'subtract': '‚àí',
                'multiply': '√ó',
                'divide': '√∑'
            };
            return symbols[operation] || operation;
        }

        // Ê∏≤ÊüìÊ≠•È™§ÂàóË°®
        function renderSteps() {
            const stepsList = document.getElementById('stepsList');

            if (state.steps.length === 0) {
                stepsList.innerHTML = '<div class="empty-steps">ÊãñÊãΩÊàñÁÇπÂáªÂè≥‰æßÊìç‰ΩúÂç°ÁâáÊ∑ªÂä†Ê≠•È™§</div>';
                return;
            }

            stepsList.innerHTML = state.steps.map((step, index) => {
                let valueDisplay = step.originalValue || step.value;
                if (step.valueType === 'variable') {
                    valueDisplay = `<span style="color: #667eea; font-weight: 600;">${step.value}</span>`;
                } else if (step.valueType === 'fraction') {
                    valueDisplay = `<span style="color: #28a745; font-weight: 600;">${formatFraction(step.value.numerator, step.value.denominator)}</span>`;
                }
                return `
                    <div class="step-item" data-step-id="${step.id}">
                        <div class="step-number">${index + 1}</div>
                        <div class="step-content">
                            <div class="step-operator">${step.operator}</div>
                            <div class="step-value">${valueDisplay}</div>
                        </div>
                        <button class="step-remove" onclick="removeStep(${step.id})">√ó</button>
                    </div>
                `;
            }).join('');
        }

        // ÁßªÈô§Ê≠•È™§
        function removeStep(stepId) {
            state.steps = state.steps.filter(step => step.id !== stepId);
            renderSteps();
            updateStepCounter();
            updateCalculateButton();
            updateVariableButton();
            updateVoiceButton(); // ÁßªÈô§Ê≠•È™§Êó∂Êõ¥Êñ∞ËØ≠Èü≥ÊåâÈíÆÁä∂ÊÄÅ
        }

        // Êõ¥Êñ∞Ê≠•È™§ËÆ°Êï∞Âô®
        function updateStepCounter() {
            document.getElementById('stepCounter').textContent = `${state.steps.length} ‰∏™Ê≠•È™§`;
        }

        // Êõ¥Êñ∞ËÆ°ÁÆóÊåâÈíÆÁä∂ÊÄÅ
        function updateCalculateButton() {
            const calculateBtn = document.getElementById('calculateBtn');
            calculateBtn.disabled = state.steps.length === 0;
        }

        // Êõ¥Êñ∞ËØ≠Èü≥Êí≠Êä•ÊåâÈíÆÁä∂ÊÄÅ
        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.disabled = state.steps.length === 0;
        }

        // Êõ¥Êñ∞ÂèòÈáèÊåâÈíÆÁä∂ÊÄÅ
        function updateVariableButton() {
            const variables = collectVariables();
            const variableBtn = document.getElementById('variableBtn');

            if (variables.length > 0) {
                variableBtn.style.display = 'block';
                const setCount = Object.keys(state.variableValues).length;
                variableBtn.textContent = setCount === variables.length ? '‰øÆÊîπÂèòÈáèÂÄº' : 'ËÆæÁΩÆÂèòÈáèÂÄº';
            } else {
                variableBtn.style.display = 'none';
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÊ≠•È™§
        function clearAllSteps() {
            if (state.steps.length === 0) return;

            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊ≠•È™§ÂêóÔºü')) {
                state.steps = [];
                state.variableValues = {}; // ÂêåÊó∂Ê∏ÖÁ©∫ÂèòÈáèÂÄº
                state.lastCalculationResult = null; // Ê∏ÖÁ©∫ËÆ°ÁÆóÁªìÊûú
                renderSteps();
                updateStepCounter();
                updateCalculateButton();
                updateVariableButton();
                updateVoiceButton(); // Ê∏ÖÁ©∫Ê≠•È™§Êó∂Êõ¥Êñ∞ËØ≠Èü≥ÊåâÈíÆÁä∂ÊÄÅ

                // Ê∏ÖÁ©∫ÁªìÊûúÊòæÁ§∫
                document.getElementById('outputResult').innerHTML = '<span style="color: #999;">Á≠âÂæÖËÆ°ÁÆóÁªìÊûú...</span>';
            }
        }

        // ËÆ°ÁÆóÁªìÊûú
        function calculateResult() {
            if (state.steps.length === 0) {
                showError('Ê≤°ÊúâÂèØËÆ°ÁÆóÁöÑÊ≠•È™§ÔºÅ');
                return;
            }

            const outputResult = document.getElementById('outputResult');
            outputResult.classList.add('calculating');
            outputResult.innerHTML = '<span style="color: #667eea;">Ê≠£Âú®ËÆ°ÁÆó...</span>';

            // Ê®°ÊãüËÆ°ÁÆóËøáÁ®ã
            setTimeout(() => {
                try {
                    const result = performCalculation();
                    displayResult(result);
                } catch (error) {
                    showError('ËÆ°ÁÆóÂá∫ÈîôÔºö' + error.message);
                }
            }, 1000);
        }

        // ÊâßË°åËÆ°ÁÆó
        function performCalculation() {
            let formula = buildDisplayFormula();
            let result = null;
            let canCalculate = true;

            // ÊûÑÂª∫Ë°®ËææÂºèÊ†ëËøõË°åËÆ°ÁÆó
            try {
                result = buildAndCalculateExpression();
                canCalculate = result !== null;
            } catch (error) {
                console.error('ËÆ°ÁÆóÈîôËØØ:', error);
                canCalculate = false;
            }

            return { result: result, formula, canCalculate };
        }

        // ÊûÑÂª∫ÊòæÁ§∫Áî®ÁöÑÂÖ¨ÂºèÔºà‰ΩøÁî®ÂéüÂßãÂÄºÔºâ
        function buildDisplayFormula() {
            // Á°Æ‰øù‰ΩøÁî®Ê≠£Á°ÆÁöÑÂéüÂßãÂÄºÔºå‰ºòÂÖà‰ªéDOMËé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÂÄº
            let initialValue;
            const displayElement = document.getElementById('initialValue');
            if (displayElement && displayElement.textContent) {
                const currentValue = displayElement.textContent.trim();
                if (currentValue) {
                    initialValue = currentValue;
                } else {
                    initialValue = state.initialOriginalValue || '0';
                }
            } else {
                initialValue = state.initialOriginalValue || '0';
            }

            let formula;

            // ÂØπ‰∫éÂàÜÊï∞Á±ªÂûãÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
            if (state.initialValueType === 'fraction') {
                // Â¶ÇÊûú initialValue ÊòØÂ≠óÁ¨¶‰∏≤ÔºåËØ¥ÊòéÊòØ‰ªéÂ§áÁî®Êú∫Âà∂Êù•ÁöÑÔºåÈúÄË¶ÅÊûÑÈÄ†ÂàÜÊï∞ÂØπË±°
                if (typeof initialValue === 'string') {
                    formula = initialValue; // Áõ¥Êé•‰ΩøÁî®Â≠óÁ¨¶‰∏≤ÂΩ¢ÂºèÁöÑÂàÜÊï∞
                } else {
                    // ‰ΩøÁî®ÂàÜÊï∞ÂØπË±°
                    formula = formatForDisplay(state.initialValue, state.initialValueType);
                }
            } else {
                // ÂØπ‰∫éÂÖ∂‰ªñÁ±ªÂûãÔºåÊ≠£Â∏∏Â§ÑÁêÜ
                formula = formatForDisplay(initialValue, state.initialValueType);
            }

            state.steps.forEach((step, index) => {
                const operator = getOperatorSymbol(step.operation);
                const value = formatForDisplay(step.originalValue || step.value, step.valueType);

                // Ê£ÄÊü•ÂêéÈù¢ÊòØÂê¶ÊúâÊõ¥È´ò‰ºòÂÖàÁ∫ßÁöÑËøêÁÆó
                const hasHigherPriorityLater = state.steps.slice(index + 1).some(laterStep =>
                    laterStep.operation === 'multiply' || laterStep.operation === 'divide'
                );

                // Â¶ÇÊûúÂΩìÂâçÊòØÂä†ÂáèÊ≥ï‰∏îÂêéÈù¢Êúâ‰πòÈô§Ê≥ïÔºåÈúÄË¶ÅÁªôÂâçÈù¢ÁöÑË°®ËææÂºèÂä†Êã¨Âè∑
                if ((step.operation === 'add' || step.operation === 'subtract') && hasHigherPriorityLater) {
                    formula = `(${formula} ${operator} ${value})`;
                } else {
                    formula += ` ${operator} ${value}`;
                }
            });

            return formula;
        }

        // ÊûÑÂª∫Âπ∂ËÆ°ÁÆóË°®ËææÂºè
        function buildAndCalculateExpression() {
            let currentValue = null;
            let hasUnsetVariable = false;

            // ‰ºòÂÖà‰ªéDOMËé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÂàùÂßãÂÄºÔºåÁ°Æ‰øù‰∏éÊòæÁ§∫‰∏ÄËá¥
            let initialValueForCalc;
            const displayElement = document.getElementById('initialValue');
            if (displayElement && displayElement.textContent) {
                const currentValue = displayElement.textContent.trim();
                if (currentValue) {
                    initialValueForCalc = currentValue;
                } else {
                    initialValueForCalc = state.initialOriginalValue || '0';
                }
            } else {
                initialValueForCalc = state.initialOriginalValue || '0';
            }

            // Â§ÑÁêÜÂàùÂßãÂÄº
            if (state.initialValueType === 'number') {
                // Â∞ÜÂ∞èÊï∞ËΩ¨Êç¢‰∏∫ÂàÜÊï∞ËøõË°åÁ≤æÁ°ÆËÆ°ÁÆó
                currentValue = decimalToFraction(parseFloat(initialValueForCalc));
            } else if (state.initialValueType === 'fraction') {
                // ÂØπ‰∫éÂàÜÊï∞Á±ªÂûãÔºåËß£ÊûêDOM‰∏≠ÁöÑÂÄº
                const parsed = parseValue(initialValueForCalc);
                if (parsed.type === 'fraction') {
                    currentValue = {
                        numerator: parsed.numerator,
                        denominator: parsed.denominator
                    };
                } else {
                    currentValue = {
                        numerator: state.initialValue.numerator,
                        denominator: state.initialValue.denominator
                    };
                }
            } else if (state.initialValueType === 'variable') {
                // Ê£ÄÊü•ÂèòÈáèÊòØÂê¶Â∑≤ËÆæÁΩÆÂÄº
                if (state.variableValues[state.initialValue]) {
                    const varValue = state.variableValues[state.initialValue];
                    if (varValue.type === 'number') {
                        currentValue = decimalToFraction(varValue.value);
                    } else if (varValue.type === 'fraction') {
                        currentValue = {
                            numerator: varValue.numerator,
                            denominator: varValue.denominator
                        };
                    }
                } else {
                    hasUnsetVariable = true;
                }
            } else {
                hasUnsetVariable = true;
            }

            // Â¶ÇÊûúÂàùÂßãÂÄºÊúâÈóÆÈ¢òÔºåÁõ¥Êé•ËøîÂõû
            if (currentValue === null && !hasUnsetVariable) {
                return null;
            }

            // Â§ÑÁêÜÊØè‰∏™Ê≠•È™§
            for (let step of state.steps) {
                let stepValue = null;

                if (step.valueType === 'number') {
                    stepValue = decimalToFraction(step.value);
                } else if (step.valueType === 'fraction') {
                    stepValue = {
                        numerator: step.value.numerator,
                        denominator: step.value.denominator
                    };
                } else if (step.valueType === 'variable') {
                    // Ê£ÄÊü•ÂèòÈáèÊòØÂê¶Â∑≤ËÆæÁΩÆÂÄº
                    if (state.variableValues[step.value]) {
                        const varValue = state.variableValues[step.value];
                        if (varValue.type === 'number') {
                            stepValue = decimalToFraction(varValue.value);
                        } else if (varValue.type === 'fraction') {
                            stepValue = {
                                numerator: varValue.numerator,
                                denominator: varValue.denominator
                            };
                        }
                    } else {
                        hasUnsetVariable = true;
                        break;
                    }
                }

                if (stepValue !== null && currentValue !== null) {
                    currentValue = applyFractionOperation(currentValue, stepValue, step.operation);
                }
            }

            // Â¶ÇÊûúÊúâÊú™ËÆæÁΩÆÁöÑÂèòÈáèÔºåËøîÂõûnullË°®Á§∫Âè™ËÉΩÊòæÁ§∫‰ª£Êï∞Ë°®ËææÂºè
            return hasUnsetVariable ? null : currentValue;
        }

        // Â∫îÁî®ÂàÜÊï∞ËøêÁÆó
        function applyFractionOperation(frac1, frac2, operation) {
            try {
                switch (operation) {
                    case 'add':
                        return addFractions(frac1, frac2);
                    case 'subtract':
                        return subtractFractions(frac1, frac2);
                    case 'multiply':
                        return multiplyFractions(frac1, frac2);
                    case 'divide':
                        return divideFractions(frac1, frac2);
                    default:
                        return frac1;
                }
            } catch (error) {
                console.error('ÂàÜÊï∞ËøêÁÆóÈîôËØØ:', error);
                return frac1;
            }
        }

        // Â∫îÁî®ËøêÁÆóÊìç‰Ωú
        function applyOperation(terms, current, stepExpression, operation) {
            switch (operation) {
                case 'add':
                    terms.push({...stepExpression});
                    break;
                case 'subtract':
                    if (stepExpression.isNumber) {
                        stepExpression.number = -stepExpression.number;
                    } else {
                        stepExpression.coefficient = -stepExpression.coefficient;
                    }
                    terms.push({...stepExpression});
                    break;
                case 'multiply':
                    // ÂØπ‰∫é‰πòÊ≥ïÔºåÈúÄË¶ÅÂ∞ÜÂΩìÂâçÊâÄÊúâÈ°πÈÉΩ‰πò‰ª•stepExpression
                    if (terms.length > 0) {
                        terms.forEach(term => {
                            if (term.isNumber && stepExpression.isNumber) {
                                // Êï∞ÂÄº √ó Êï∞ÂÄº
                                term.number *= stepExpression.number;
                            } else if (term.isNumber && stepExpression.variable) {
                                // Êï∞ÂÄº √ó ÂèòÈáè
                                term.variable = stepExpression.variable;
                                term.coefficient = term.number * stepExpression.coefficient;
                                term.isNumber = false;
                                term.number = 0;
                            } else if (term.variable && stepExpression.isNumber) {
                                // ÂèòÈáè √ó Êï∞ÂÄº
                                term.coefficient *= stepExpression.number;
                            } else if (term.variable && stepExpression.variable) {
                                // ÂèòÈáè √ó ÂèòÈáè
                                term.variable += stepExpression.variable;
                                term.coefficient *= stepExpression.coefficient;
                            }
                        });
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÁé∞ÊúâÈ°πÔºåÁõ¥Êé•Ê∑ªÂä†
                        terms.push({...stepExpression});
                    }
                    break;
                case 'divide':
                    // ÂØπ‰∫éÈô§Ê≥ïÔºåÈúÄË¶ÅÂ∞ÜÂΩìÂâçÊâÄÊúâÈ°πÈÉΩÈô§‰ª•stepExpression
                    if (terms.length > 0 && stepExpression.isNumber) {
                        terms.forEach(term => {
                            if (term.isNumber) {
                                // Êï∞ÂÄº √∑ Êï∞ÂÄº
                                term.number /= stepExpression.number;
                            } else if (term.variable) {
                                // ÂèòÈáè √∑ Êï∞ÂÄº
                                term.coefficient /= stepExpression.number;
                            }
                        });
                    }
                    break;
            }
        }

        // ÈÄâÊã©ËøêÁÆóÊìç‰Ωú
        function selectOperation(operation) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈÄâÊã©Áä∂ÊÄÅ
            document.querySelectorAll('.op-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#667eea';
            });

            // ËÆæÁΩÆÊñ∞ÁöÑÈÄâÊã©Áä∂ÊÄÅ
            const selectedBtn = document.querySelector(`[data-operation="${operation}"]`);
            selectedBtn.style.background = '#667eea';
            selectedBtn.style.color = 'white';

            state.selectedOperation = operation;

            // ÂêØÁî®Ê∑ªÂä†ÊåâÈíÆ
            updateAddButtonState();
        }

        // Âø´ÈÄüÊ∑ªÂä†Ê≠•È™§
        function quickAddStep() {
            if (!state.selectedOperation) {
                showError('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËøêÁÆóÊìç‰ΩúÔºÅ');
                return;
            }

            const valueInput = document.getElementById('quickValueInput');
            const value = valueInput.value.trim();

            if (!value) {
                showError('ËØ∑ËæìÂÖ•Êìç‰ΩúÊï∞ÔºÅ');
                return;
            }

            const parsed = parseValue(value);

            if (parsed.type === 'invalid') {
                showError('Êó†ÊïàËæìÂÖ•ÔºÅËØ∑ËæìÂÖ•Êï∞Â≠óÊàñÊúâÊïàÁöÑÂèòÈáèÂêç„ÄÇ');
                return;
            }

            // È™åËØÅÈô§Ê≥ï
            if (state.selectedOperation === 'divide') {
                let isZero = false;

                if (parsed.type === 'number' && parsed.value === 0) {
                    isZero = true;
                } else if (parsed.type === 'fraction' && parsed.numerator === 0) {
                    isZero = true;
                }

                if (isZero) {
                    showError('Èô§Êï∞‰∏çËÉΩ‰∏∫Èõ∂ÔºÅ');
                    return;
                }
            }

            // ÂàõÂª∫Êìç‰ΩúÂØπË±°
            const operation = {
                operation: state.selectedOperation,
                name: getOperationName(state.selectedOperation)
            };

            // Ê∑ªÂä†Ê≠•È™§
            addStep(operation, parsed);

            // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
            resetOperationSelection();
        }

        // Ëé∑ÂèñÊìç‰ΩúÂêçÁß∞
        function getOperationName(operation) {
            const names = {
                'add': 'Âä†Ê≥ï',
                'subtract': 'ÂáèÊ≥ï',
                'multiply': '‰πòÊ≥ï',
                'divide': 'Èô§Ê≥ï'
            };
            return names[operation] || operation;
        }

        // ÈáçÁΩÆÊìç‰ΩúÈÄâÊã©
        function resetOperationSelection() {
            state.selectedOperation = null;
            document.querySelectorAll('.op-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#667eea';
            });
            document.getElementById('quickValueInput').value = '1';
            updateAddButtonState();
        }

        // Êõ¥Êñ∞Ê∑ªÂä†ÊåâÈíÆÁä∂ÊÄÅ
        function updateAddButtonState() {
            const addBtn = document.getElementById('quickAddBtn');
            addBtn.disabled = state.selectedOperation === null;
        }

        // ÁÆÄÂåñÂπ∂ÂêàÂπ∂È°π
        function simplifyAndCombineTerms(terms) {
            let variableTerms = {};
            let numberSum = 0;

            terms.forEach(term => {
                if (term.isNumber) {
                    numberSum += term.number;
                } else if (term.variable) {
                    if (!variableTerms[term.variable]) {
                        variableTerms[term.variable] = 0;
                    }
                    variableTerms[term.variable] += term.coefficient;
                }
            });

            // ÊûÑÂª∫ÁªìÊûúÂ≠óÁ¨¶‰∏≤
            let resultParts = [];

            // Â§ÑÁêÜÂèòÈáèÈ°π
            Object.keys(variableTerms).forEach(variable => {
                let coefficient = variableTerms[variable];
                if (coefficient !== 0) {
                    let termStr = '';
                    if (coefficient === 1) {
                        termStr = variable;
                    } else if (coefficient === -1) {
                        termStr = `-${variable}`;
                    } else {
                        termStr = `${coefficient}${variable}`;
                    }
                    resultParts.push(termStr);
                }
            });

            // Â§ÑÁêÜÊï∞ÂÄºÈ°π
            if (numberSum !== 0) {
                resultParts.push(formatNumber(numberSum));
            }

            if (resultParts.length === 0) {
                return '0';
            }

            return resultParts.join(' + ').replace(/\+ -/g, '- ');
        }

        // Ê†ºÂºèÂåñÂÄºÊòæÁ§∫
        function formatValue(value, type) {
            if (type === 'variable') {
                return value;
            } else if (type === 'number') {
                return value.toString();
            } else {
                return '0';
            }
        }

        // Ê†ºÂºèÂåñÊòæÁ§∫Ôºà‰ΩøÁî®ÂéüÂßãÂÄºÔºâ
        function formatForDisplay(originalValue, type) {
            // Â§ÑÁêÜ undefined Êàñ null ÂÄº
            if (originalValue === undefined || originalValue === null) {
                return '0';
            }

            if (type === 'variable') {
                return originalValue;
            } else if (type === 'number') {
                // ÂØπ‰∫éÊï∞Â≠óÁ±ªÂûãÔºåÁõ¥Êé•ËøîÂõûÂ≠óÁ¨¶‰∏≤ÂΩ¢Âºè
                return originalValue.toString();
            } else if (type === 'fraction') {
                // ÂØπ‰∫éÂàÜÊï∞Á±ªÂûãÔºå‰ºòÂÖà‰ΩøÁî® originalValue Â±ûÊÄß
                if (originalValue.originalValue) {
                    return originalValue.originalValue;
                } else if (originalValue.numerator !== undefined && originalValue.denominator !== undefined) {
                    return `${originalValue.numerator}/${originalValue.denominator}`;
                } else {
                    // Â¶ÇÊûúÂàÜÊï∞ÂØπË±°ÁªìÊûÑ‰∏çÂÆåÊï¥ÔºåËøîÂõûÈªòËÆ§ÂÄº
                    return '0';
                }
            } else {
                return originalValue ? originalValue.toString() : '0';
            }
        }

        // Áªô‰ª£Êï∞Ë°®ËææÂºè‰∏≠ÁöÑË¥üÊï∞Ê∑ªÂä†Êã¨Âè∑
        function addParenthesesForNegatives(expression) {
            // ÂåπÈÖçË°®ËææÂºè‰∏≠ÁöÑË¥üÊï∞Ê®°ÂºèÔºàÂåÖÊã¨Ë¥üÊï∞„ÄÅË¥üÂàÜÊï∞Ôºâ
            return expression.replace(/(-\d+(?:\/\d+)?)(?![\d\/])/g, '($1)');
        }

        // ÁÆÄÂåñ‰ª£Êï∞Ë°®ËææÂºè
        function simplifyAlgebraicExpression(expression) {
            // ÂÖàÁÆÄÂåñÔºåÂÜçÁªôË¥üÊï∞Ê∑ªÂä†Êã¨Âè∑
            const simplified = expression; // ÁÆÄÂçïÁöÑË°®ËææÂºèÁÆÄÂåñÔºåÁõ¥Êé•ËøîÂõûÂéüË°®ËææÂºè
            return addParenthesesForNegatives(simplified);
        }

        // ÊòæÁ§∫ÁªìÊûú
        function displayResult(calculation) {
            const outputResult = document.getElementById('outputResult');

            outputResult.classList.remove('calculating');

            let resultDisplay;

            if (calculation.canCalculate && calculation.result !== null) {
                // ÂèØ‰ª•ËøõË°åÊï∞ÂÄºËÆ°ÁÆó
                let formattedResult;
                if (typeof calculation.result === 'number') {
                    formattedResult = formatNumber(calculation.result);
                } else if (typeof calculation.result === 'object' && calculation.result.numerator !== undefined) {
                    // ÂàÜÊï∞ÁªìÊûú
                    formattedResult = formatFraction(calculation.result.numerator, calculation.result.denominator);
                } else {
                    formattedResult = calculation.result.toString();
                }

                // Â≠òÂÇ®ËÆ°ÁÆóÁªìÊûúÁî®‰∫éËØ≠Èü≥Êí≠Êä•
                state.lastCalculationResult = {
                    formula: calculation.formula,
                    result: formattedResult,
                    canCalculate: true
                };

                // Â¶ÇÊûú‰ΩøÁî®‰∫ÜÂèòÈáèÂÄºÔºåÊòæÁ§∫ÂèòÈáèÂÄº‰ø°ÊÅØ
                const setVariables = Object.keys(state.variableValues);
                let variableInfo = '';
                if (setVariables.length > 0) {
                    const varList = setVariables.map(varName => {
                        const varValue = state.variableValues[varName];
                        const displayValue = varValue.type === 'fraction'
                            ? formatFraction(varValue.numerator, varValue.denominator)
                            : varValue.value;
                        return `${varName} = ${displayValue}`;
                    }).join(', ');
                    variableInfo = `<div style="font-size: 0.7em; color: #666; margin-top: 8px; font-style: italic;">
                        ÂÖ∂‰∏≠Ôºö${varList}
                    </div>`;
                }

                resultDisplay = `
                    <div>
                        <span style="color: #28a745; font-size: 1.2em;">${formattedResult}</span>
                        ${variableInfo}
                    </div>
                `;
            } else {
                // Âè™ËÉΩÊòæÁ§∫‰ª£Êï∞Ë°®ËææÂºè
                const simplifiedFormula = simplifyAlgebraicExpression(calculation.formula);

                // Â≠òÂÇ®ËÆ°ÁÆóÁªìÊûúÁî®‰∫éËØ≠Èü≥Êí≠Êä•
                state.lastCalculationResult = {
                    formula: calculation.formula,
                    result: simplifiedFormula,
                    canCalculate: false
                };

                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™ËÆæÁΩÆÁöÑÂèòÈáè
                const variables = collectVariables();
                const unsetVariables = variables.filter(v => !state.variableValues[v]);

                let hint = '';
                if (unsetVariables.length > 0) {
                    hint = `<div style="font-size: 0.7em; color: #dc3545; margin-top: 8px; font-style: italic;">
                        ÁÇπÂáª"ËÆæÁΩÆÂèòÈáèÂÄº"‰∏∫ ${unsetVariables.join(', ')} ËµãÂÄºËøõË°åËÆ°ÁÆó
                    </div>`;
                }

                resultDisplay = `
                    <div>
                        <span style="color: #667eea; font-style: italic;">${simplifiedFormula}</span>
                        ${hint}
                    </div>
                `;
            }

            outputResult.innerHTML = resultDisplay;
        }

        // Êñ∞ÁöÑÊñáÊú¨ËΩ¨ËØ≠Èü≥ÂáΩÊï∞
        async function textToSpeech(text, voice = "Cherry", languageType = "Chinese") {
            console.log('Sending TTS request:', { text, voice, languageType });

            const response = await fetch('http://106.53.170.240:8890/tts', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer bobwork11012205BOB@@',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    voice: voice,
                    language_type: languageType
                })
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            return await response.json();
        }

        // ËØ≠Èü≥Êí≠Êä•ÂäüËÉΩÔºàËá™Âä®ËÆ°ÁÆóÂπ∂Êí≠Êä•Ôºâ
        async function speakResult() {
            if (state.steps.length === 0) {
                showError('ËØ∑ÂÖàÊ∑ªÂä†ËøêÁÆóÊ≠•È™§ÔºÅ');
                return;
            }

            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.classList.add('speaking');
            voiceBtn.disabled = true;

            try {
                // 1. È¶ñÂÖàÊâßË°åËÆ°ÁÆóÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâËÆ°ÁÆóÁªìÊûúÔºâ
                let calculation;
                if (!state.lastCalculationResult) {
                    // ÊòæÁ§∫ËÆ°ÁÆó‰∏≠Áä∂ÊÄÅ
                    const outputResult = document.getElementById('outputResult');
                    outputResult.classList.add('calculating');
                    outputResult.innerHTML = '<span style="color: #667eea;">Ê≠£Âú®ËÆ°ÁÆóÂπ∂ÂáÜÂ§áËØ≠Èü≥Êí≠Êä•...</span>';

                    calculation = performCalculation();
                    // ÊöÇÊó∂‰∏çÊòæÁ§∫ÁªìÊûúÔºåÁ≠âÈü≥È¢ëÂºÄÂßãÊí≠ÊîæÊó∂ÂÜçÊòæÁ§∫
                } else {
                    // ‰ΩøÁî®Â∑≤ÊúâÁöÑËÆ°ÁÆóÁªìÊûú
                    calculation = state.lastCalculationResult;
                }

                // 2. ÊûÑÂª∫Êí≠Êä•ÊñáÊú¨
                let speechText;
                const initialValueElement = document.getElementById('initialValue');
                const initialValue = initialValueElement.textContent.trim();

                // Ê†ºÂºèÂåñÂàùÂßãÂÄº‰∏∫ËØ≠Èü≥Êí≠Êä•Ê†ºÂºè
                const parsedInitialValue = parseValue(initialValue);
                const formattedInitialValue = formatValueForSpeech(
                    parsedInitialValue.type === 'fraction' ? parsedInitialValue :
                    parsedInitialValue.type === 'number' ? parsedInitialValue.value :
                    parsedInitialValue.value,
                    parsedInitialValue.type
                );

                // ÊûÑÂª∫Ê≠•È™§ÊèèËø∞
                let stepsDescription = '';
                state.steps.forEach((step, index) => {
                    const operator = formatOperatorForSpeech(step.operation);
                    const formattedValue = formatValueForSpeech(step.value, step.valueType);

                    if (index === 0) {
                        stepsDescription = `${operator}${formattedValue}`;
                    } else {
                        stepsDescription += `ÔºåÁÑ∂Âêé${operator}${formattedValue}`;
                    }
                });

                if (calculation.canCalculate && calculation.result !== null) {
                    console.log('Calculation result:', calculation.result, 'Type:', typeof calculation.result);
                    const formattedResult = formatNumberForSpeech(calculation.result);
                    console.log('Formatted result for speech:', formattedResult);
                    speechText = `${formattedInitialValue}ÔºåÁªèËøá${stepsDescription}ÁöÑËÆ°ÁÆóÔºåÁªìÊûúÊòØ${formattedResult}`;
                } else {
                    speechText = `Ë°®ËææÂºè${calculation.formula}ÈúÄË¶ÅËÆæÁΩÆÂèòÈáèÂÄºÂêéÊâçËÉΩËÆ°ÁÆóÂÖ∑‰ΩìÁªìÊûú`;
                }

                // 3. Ë∞ÉÁî®ÊñáÊú¨ËΩ¨ËØ≠Èü≥
                console.log('Sending TTS request:', speechText);
                const data = await textToSpeech(speechText);

                if (data.output && data.output.audio && data.output.audio.url) {
                    // 4. Êí≠ÊîæÈü≥È¢ë
                    const audio = new Audio(data.output.audio.url);

                    // Âú®Èü≥È¢ëÂºÄÂßãÊí≠ÊîæÊó∂ÊòæÁ§∫ËÆ°ÁÆóÁªìÊûú
                    audio.addEventListener('play', () => {
                        // Â¶ÇÊûúÊòØÊñ∞ÁöÑËÆ°ÁÆóÔºåÁé∞Âú®ÊâçÊòæÁ§∫ÁªìÊûú
                        if (!state.lastCalculationResult) {
                            state.lastCalculationResult = calculation;
                            displayResult(calculation);
                        }
                        // Êõ¥Êñ∞ÊèêÁ§∫‰ø°ÊÅØ
                        const outputResult = document.getElementById('outputResult');
                        if (outputResult.classList.contains('calculating')) {
                            outputResult.classList.remove('calculating');
                        }
                        console.log('Èü≥È¢ëÂºÄÂßãÊí≠ÊîæÔºåÊòæÁ§∫ËÆ°ÁÆóÁªìÊûú');
                    });

                    // Ê∑ªÂä†Èü≥È¢ëÂä†ËΩΩÂÆåÊàê‰∫ã‰ª∂ÁõëÂê¨
                    audio.addEventListener('canplay', () => {
                        console.log('Èü≥È¢ëÂä†ËΩΩÂÆåÊàêÔºåÂáÜÂ§áÊí≠Êîæ');
                    });

                    // Ê∑ªÂä†Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•‰∫ã‰ª∂ÁõëÂê¨
                    audio.addEventListener('error', (e) => {
                        console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
                        // Â¶ÇÊûúÈü≥È¢ëÊí≠ÊîæÂ§±Ë¥•Ôºå‰ªçÁÑ∂ÊòæÁ§∫ËÆ°ÁÆóÁªìÊûú
                        if (!state.lastCalculationResult) {
                            state.lastCalculationResult = calculation;
                            displayResult(calculation);
                        }
                        const outputResult = document.getElementById('outputResult');
                        if (outputResult.classList.contains('calculating')) {
                            outputResult.classList.remove('calculating');
                        }
                    });

                    await audio.play();

                    // 5. ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                    showSuccessMessage('ËØ≠Èü≥Êí≠Êä•ÂÆåÊàê');
                } else {
                    throw new Error('ËØ≠Èü≥ÂêàÊàêËøîÂõûÊï∞ÊçÆÊ†ºÂºèÈîôËØØ');
                }

            } catch (error) {
                console.error('ËØ≠Èü≥Êí≠Êä•ÈîôËØØ:', error);
                showError('ËØ≠Èü≥Êí≠Êä•Â§±Ë¥•Ôºö' + error.message);

                // Â¶ÇÊûúÂá∫Áé∞ÈîôËØØ‰∏îËøòÊ≤°ÊúâÊòæÁ§∫ÁªìÊûúÔºåÂàôÊòæÁ§∫ËÆ°ÁÆóÁªìÊûú
                if (!state.lastCalculationResult && calculation) {
                    state.lastCalculationResult = calculation;
                    displayResult(calculation);
                }

                // Ê∏ÖÈô§ËÆ°ÁÆóÁä∂ÊÄÅ
                const outputResult = document.getElementById('outputResult');
                if (outputResult.classList.contains('calculating')) {
                    outputResult.classList.remove('calculating');
                }
            } finally {
                voiceBtn.classList.remove('speaking');
                voiceBtn.disabled = false;
            }
        }

        // Ê†ºÂºèÂåñÊï∞Â≠óÁî®‰∫éËØ≠Èü≥Êí≠Êä•
        function formatNumberForSpeech(result) {
            if (typeof result === 'number') {
                // Êï¥Êï∞Áõ¥Êé•ËØªÔºåË¥üÊï∞Êîπ‰∏∫"Ë¥üX"
                if (Number.isInteger(result)) {
                    return result < 0 ? `Ë¥ü${Math.abs(result)}` : result.toString();
                }
                // Â∞èÊï∞ËØª‰Ωú"XÁÇπY"ÔºåË¥üÊï∞Êîπ‰∏∫"Ë¥üXÁÇπY"
                return result < 0 ?
                    `Ë¥ü${Math.abs(result).toString().replace('.', 'ÁÇπ')}` :
                    result.toString().replace('.', 'ÁÇπ');
            } else if (typeof result === 'object' && result.numerator !== undefined) {
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êï¥Êï∞ÔºàÂàÜÊØç‰∏∫1Ôºâ
                const numerator = result.numerator;
                const denominator = result.denominator;

                if (denominator === 1) {
                    // ÊòØÊï¥Êï∞ÔºåË¥üÊï∞Êîπ‰∏∫"Ë¥üX"
                    return numerator < 0 ? `Ë¥ü${Math.abs(numerator)}` : numerator.toString();
                } else if (denominator === -1) {
                    // Â§ÑÁêÜ-1ÂàÜÊØçÁöÑÊÉÖÂÜµ
                    const value = -numerator;
                    return value < 0 ? `Ë¥ü${Math.abs(value)}` : value.toString();
                } else {
                    // ÁúüÊ≠£ÁöÑÂàÜÊï∞
                    if (numerator < 0) {
                        return `Ë¥ü${Math.abs(numerator)}ÂàÜ‰πã${denominator}`;
                    } else {
                        return `${numerator}ÂàÜ‰πã${denominator}`;
                    }
                }
            } else {
                return result.toString();
            }
        }

        // Ê†ºÂºèÂåñËøêÁÆóÁ¨¶‰∏∫ËØ≠Èü≥Êí≠Êä•Ê†ºÂºè
        function formatOperatorForSpeech(operator) {
            const operatorMap = {
                'add': 'Âä†',
                'subtract': 'Âáè',
                'multiply': '‰πò',
                'divide': 'Èô§'
            };
            return operatorMap[operator] || operator;
        }

        // Ê†ºÂºèÂåñÊï∞ÂÄºÔºàÂ§ÑÁêÜË¥üÊï∞Á¨¶Âè∑Ôºâ
        function formatValueForSpeech(value, type) {
            if (type === 'variable') {
                return value;
            } else if (type === 'number') {
                return value < 0 ? `Ë¥ü${Math.abs(value)}` : value.toString();
            } else if (type === 'fraction') {
                if (value.numerator < 0) {
                    return `Ë¥ü${Math.abs(value.numerator)}ÂàÜ‰πã${value.denominator}`;
                } else {
                    return `${value.numerator}ÂàÜ‰πã${value.denominator}`;
                }
            } else {
                return value.toString();
            }
        }

        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
                border-radius: 10px;
                padding: 12px 20px;
                z-index: 2000;
                max-width: 400px;
                font-size: 0.9em;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                animation: slideInDown 0.3s ease;
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.opacity = '0';
                successDiv.style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 300);
            }, 2000);
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.zIndex = '2000';
            errorDiv.style.maxWidth = '400px';

            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(errorDiv)) {
                        document.body.removeChild(errorDiv);
                    }
                }, 300);
            }, 3000);
        }

        // ÈîÆÁõòÊîØÊåÅ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeVariableModal();
            }

            // Âø´Êç∑ÈîÆ Ctrl/Cmd + V ÊâìÂºÄÂèòÈáèËÆæÁΩÆ
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                e.preventDefault();
                const variables = collectVariables();
                if (variables.length > 0) {
                    showVariableModal();
                }
            }
        });

        document.getElementById('modalInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                confirmOperation();
            }
        });

        // Ê®°ÊÄÅÊ°ÜËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('modalInput').addEventListener('input', function(e) {
            updateModalInputType();
        });

        // Ê®°ÊÄÅÊ°ÜÁÑ¶ÁÇπ‰∫ã‰ª∂
        document.getElementById('modalInput').addEventListener('focus', function(e) {
            if (e.target.value === '0') {
                e.target.value = '';
            }
        });

        document.getElementById('modalInput').addEventListener('blur', function(e) {
            if (e.target.value.trim() === '') {
                e.target.value = '0';
                updateModalInputType();
            }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('operationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ÁÇπÂáªÂèòÈáèÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('variableModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVariableModal();
            }
        });

        // ÂèòÈáèÊ®°ÊÄÅÊ°ÜÈîÆÁõòÊîØÊåÅ
        document.getElementById('variableModal').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                confirmVariableValues();
            }
        });

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initQuickOperations();
            updateStepCounter();
            updateCalculateButton();
            updateVariableButton();
            updateVoiceButton(); // ÂàùÂßãÂåñËØ≠Èü≥ÊåâÈíÆÁä∂ÊÄÅ
            updateModalInputType();
        });
    </script>
</body>
</html>