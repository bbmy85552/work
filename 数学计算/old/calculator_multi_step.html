<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数值转换机 - 多步运算版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 1400px;
            width: 100%;
            min-height: 700px;
            display: flex;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .left-panel {
            flex: 1.2;
            padding: 40px;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2.2em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .input-section, .output-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .input-section:focus-within, .output-section:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 10px;
            border-radius: 2px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: white;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .processor-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e1e5e9;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .processor-section.hidden {
            height: 60px;
            padding: 10px 20px;
        }

        .processor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .processor-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: #667eea;
            transition: transform 0.3s ease;
            padding: 5px;
        }

        .toggle-btn:hover {
            transform: scale(1.1);
        }

        .toggle-btn.rotated {
            transform: rotate(180deg);
        }

        .processor-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.5s ease;
        }

        .processor-section.hidden .processor-content {
            display: none;
        }

        .step-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
            min-height: 50px;
            position: relative;
        }

        .step-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 0 5px;
            font-weight: 500;
            color: #666;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .step-item.active {
            background: #667eea;
            color: white;
            transform: scale(1.05);
            border-color: #764ba2;
        }

        .step-item.completed {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }

        .flow-arrow {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
        }

        .operation-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #667eea;
            font-weight: 600;
            color: #333;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .operations-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .operations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-counter {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .operation-btn {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .operation-btn:hover:not(:disabled) {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }

        .operation-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .operation-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .operation-info {
            flex: 1;
        }

        .operation-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .operation-desc {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .operation-icon {
            font-size: 1.8em;
            margin-left: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .action-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .action-btn.secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .action-btn.secondary:hover:not(:disabled) {
            border-color: #667eea;
            background: white;
        }

        .action-btn:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .history-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e1e5e9;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .history-title::before {
            content: '📋';
            margin-right: 8px;
        }

        .history-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .history-step {
            font-weight: 600;
            color: #667eea;
            margin-right: 10px;
        }

        .history-expression {
            flex: 1;
            color: #333;
        }

        .history-result {
            font-weight: 600;
            color: #28a745;
        }

        .result-display {
            font-size: 2em;
            font-weight: 700;
            color: #333;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e1e5e9;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .result-display.calculating {
            animation: calculating 1s infinite;
        }

        @keyframes calculating {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn.secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .modal-btn:hover {
            transform: translateY(-1px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            animation: shake 0.5s ease;
            font-size: 0.9em;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.ready {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.complete {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 左侧面板 -->
        <div class="left-panel">
            <h1>数值转换机</h1>

            <!-- 输入区 -->
            <div class="input-section">
                <div class="section-title">
                    输入区
                    <span class="badge" id="inputStatus">初始值</span>
                </div>
                <input type="text" class="input-field" id="inputValue" placeholder="请输入数值或变量，如 10, x, 3.14">
            </div>

            <!-- 核心处理模块 -->
            <div class="processor-section" id="processorSection">
                <div class="processor-header">
                    <div class="processor-title">核心处理模块</div>
                    <button class="toggle-btn" id="toggleProcessor" onclick="toggleProcessor()">▼</button>
                </div>
                <div class="processor-content" id="processorContent">
                    <!-- 步骤流程指示器 -->
                    <div class="step-flow">
                        <div class="step-item" id="step1">步骤 1</div>
                        <div class="flow-arrow">→</div>
                        <div class="step-item" id="step2">步骤 2</div>
                        <div class="flow-arrow">→</div>
                        <div class="step-item" id="step3">步骤 3</div>
                    </div>

                    <!-- 当前操作显示 -->
                    <div class="operation-display" id="operationDisplay">
                        等待第一步操作...
                    </div>

                    <!-- 进度条 -->
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 输出区 -->
            <div class="output-section">
                <div class="section-title">
                    输出区
                    <span class="status-badge ready" id="outputStatus">准备就绪</span>
                </div>
                <div class="result-display" id="outputResult">
                    <span style="color: #999;">等待计算结果...</span>
                </div>
            </div>

            <!-- 操作历史 -->
            <div class="history-section">
                <div class="history-title">操作历史</div>
                <div id="historyList">
                    <div class="empty-state">暂无操作记录</div>
                </div>
            </div>
        </div>

        <!-- 右侧面板 -->
        <div class="right-panel">
            <h1>操作面板</h1>

            <div class="operations-section">
                <div class="operations-header">
                    <h3 style="color: #333; margin: 0;">选择运算</h3>
                    <div class="step-counter" id="stepCounter">步骤 1/3</div>
                </div>

                <!-- 加法操作 -->
                <div class="operation-btn" onclick="selectOperation('add')" id="addBtn">
                    <div class="operation-info">
                        <div class="operation-name">加一个数</div>
                        <div class="operation-desc">可输入正/负数，支持变量</div>
                    </div>
                    <div class="operation-icon">+</div>
                </div>

                <!-- 减法操作 -->
                <div class="operation-btn" onclick="selectOperation('subtract')" id="subtractBtn">
                    <div class="operation-info">
                        <div class="operation-name">减一个数</div>
                        <div class="operation-desc">需验证，支持变量</div>
                    </div>
                    <div class="operation-icon">−</div>
                </div>

                <!-- 乘法操作 -->
                <div class="operation-btn" onclick="selectOperation('multiply')" id="multiplyBtn">
                    <div class="operation-info">
                        <div class="operation-name">乘一个数</div>
                        <div class="operation-desc">可正负，支持变量</div>
                    </div>
                    <div class="operation-icon">×</div>
                </div>

                <!-- 除法操作 -->
                <div class="operation-btn" onclick="selectOperation('divide')" id="divideBtn">
                    <div class="operation-info">
                        <div class="operation-name">除一个数</div>
                        <div class="operation-desc">需驱动，支持变量</div>
                    </div>
                    <div class="operation-icon">÷</div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="action-buttons">
                <button class="action-btn secondary" id="resetBtn" onclick="resetAll()">
                    重置
                </button>
                <button class="action-btn primary" id="nextStepBtn" onclick="nextStep()" disabled>
                    下一步
                </button>
            </div>

            <div class="action-buttons">
                <button class="action-btn primary" id="calculateBtn" onclick="calculateAll()" disabled style="width: 100%;">
                    计算最终结果
                </button>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal" id="operationModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">请输入操作数</div>
            <input type="text" class="modal-input" id="modalInput" placeholder="请输入数值或变量">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">取消</button>
                <button class="modal-btn primary" onclick="confirmOperation()">确认</button>
            </div>
            <div id="modalError"></div>
        </div>
    </div>

    <script>
        // 全局状态管理
        const state = {
            currentValue: null,
            currentStep: 1,
            maxSteps: 3,
            operations: [],
            isProcessorHidden: false,
            isProcessing: false
        };

        // 切换处理模块显示/隐藏
        function toggleProcessor() {
            const processorSection = document.getElementById('processorSection');
            const toggleBtn = document.getElementById('toggleProcessor');

            state.isProcessorHidden = !state.isProcessorHidden;

            if (state.isProcessorHidden) {
                processorSection.classList.add('hidden');
                toggleBtn.classList.add('rotated');
            } else {
                processorSection.classList.remove('hidden');
                toggleBtn.classList.remove('rotated');
            }
        }

        // 选择操作
        function selectOperation(operation) {
            if (state.isProcessing) {
                showError('正在处理中，请稍候...');
                return;
            }

            // 检查是否有初始值
            if (!state.currentValue && state.currentStep === 1) {
                const input = document.getElementById('inputValue').value;
                if (!input.trim()) {
                    showError('请先在输入区输入初始值！');
                    document.getElementById('inputValue').focus();
                    return;
                }
                state.currentValue = input;
                updateInputStatus('已设置');
            }

            // 高亮选中的操作按钮
            document.querySelectorAll('.operation-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(operation + 'Btn').classList.add('active');

            // 显示操作模态框
            showOperationModal(operation);
        }

        // 显示操作模态框
        function showOperationModal(operation) {
            const modal = document.getElementById('operationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalInput = document.getElementById('modalInput');

            const titles = {
                'add': `步骤 ${state.currentStep} - 加法操作`,
                'subtract': `步骤 ${state.currentStep} - 减法操作`,
                'multiply': `步骤 ${state.currentStep} - 乘法操作`,
                'divide': `步骤 ${state.currentStep} - 除法操作`
            };

            modalTitle.textContent = titles[operation];
            modalInput.value = '';
            modalInput.focus();

            // 清除之前的错误信息
            document.getElementById('modalError').innerHTML = '';

            modal.classList.add('show');
        }

        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('operationModal');
            modal.classList.remove('show');
        }

        // 确认操作
        function confirmOperation() {
            const modalInput = document.getElementById('modalInput');
            const modalError = document.getElementById('modalError');
            const value = modalInput.value.trim();

            if (!value) {
                modalError.innerHTML = '<div class="error-message">请输入操作数！</div>';
                return;
            }

            // 获取当前选中的操作
            const activeBtn = document.querySelector('.operation-btn.active');
            if (!activeBtn) {
                modalError.innerHTML = '<div class="error-message">请先选择运算操作！</div>';
                return;
            }

            const operation = activeBtn.id.replace('Btn', '');

            // 特殊验证逻辑
            if (operation === 'subtract' && !validateSubtraction(value)) {
                modalError.innerHTML = '<div class="error-message">减法操作验证失败！请输入有效的数值。</div>';
                return;
            }

            if (operation === 'divide' && !validateDivision(value)) {
                modalError.innerHTML = '<div class="error-message">除法操作驱动失败！除数不能为零。</div>';
                return;
            }

            // 保存操作
            state.operations.push({
                step: state.currentStep,
                operation: operation,
                value: value,
                currentValue: state.currentValue
            });

            closeModal();
            updateOperationDisplay(operation, value);
            enableNextStep();
        }

        // 减法验证
        function validateSubtraction(value) {
            // 这里可以添加更复杂的验证逻辑
            return true;
        }

        // 除法验证
        function validateDivision(value) {
            // 检查除数是否为零
            if (value === '0') return false;
            return true;
        }

        // 更新操作显示
        function updateOperationDisplay(operation, value) {
            const operationDisplay = document.getElementById('operationDisplay');
            const operators = {
                'add': '+',
                'subtract': '−',
                'multiply': '×',
                'divide': '÷'
            };

            if (state.currentStep === 1) {
                operationDisplay.textContent = `${state.currentValue} ${operators[operation]} ${value}`;
            } else {
                operationDisplay.textContent = `上一步结果 ${operators[operation]} ${value}`;
            }

            // 更新步骤指示器
            updateStepIndicator();
        }

        // 更新步骤指示器
        function updateStepIndicator() {
            // 清除所有步骤状态
            for (let i = 1; i <= state.maxSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('active', 'completed');

                if (i < state.currentStep) {
                    stepElement.classList.add('completed');
                    stepElement.textContent = `步骤 ${i} ✓`;
                } else if (i === state.currentStep) {
                    stepElement.classList.add('active');
                    stepElement.textContent = `步骤 ${i}`;
                } else {
                    stepElement.textContent = `步骤 ${i}`;
                }
            }

            // 更新进度条
            const progress = (state.currentStep / state.maxSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // 更新步骤计数器
            document.getElementById('stepCounter').textContent = `步骤 ${state.currentStep}/${state.maxSteps}`;
        }

        // 启用下一步
        function enableNextStep() {
            const nextStepBtn = document.getElementById('nextStepBtn');
            nextStepBtn.disabled = false;

            // 取消操作按钮的高亮
            document.querySelectorAll('.operation-btn').forEach(btn => btn.classList.remove('active'));
        }

        // 下一步
        function nextStep() {
            if (state.currentStep >= state.maxSteps) {
                showError('已达到最大步骤数！');
                return;
            }

            state.currentStep++;
            updateStepIndicator();

            // 禁用下一步按钮
            document.getElementById('nextStepBtn').disabled = true;

            // 如果是最后一步，启用计算按钮
            if (state.currentStep >= state.maxSteps) {
                document.getElementById('nextStepBtn').style.display = 'none';
                document.getElementById('calculateBtn').disabled = false;
            }

            // 更新操作显示
            document.getElementById('operationDisplay').textContent = `等待第 ${state.currentStep} 步操作...`;
        }

        // 计算所有操作
        function calculateAll() {
            if (state.operations.length === 0) {
                showError('没有可计算的操作！');
                return;
            }

            state.isProcessing = true;
            const outputResult = document.getElementById('outputResult');
            const outputStatus = document.getElementById('outputStatus');

            outputResult.classList.add('calculating');
            outputResult.innerHTML = '<span style="color: #667eea;">正在计算...</span>';
            outputStatus.textContent = '计算中';
            outputStatus.className = 'status-badge processing';

            // 模拟计算过程
            setTimeout(() => {
                try {
                    const result = performMultiStepCalculation();
                    displayResult(result);
                    addToHistory(result);
                } catch (error) {
                    showError('计算出错：' + error.message);
                } finally {
                    state.isProcessing = false;
                }
            }, 1500);
        }

        // 执行多步计算
        function performMultiStepCalculation() {
            let result = state.currentValue;
            let expression = state.currentValue;

            // 尝试解析为数值进行计算
            let numericResult = parseFloat(result);
            let isNumeric = !isNaN(numericResult);

            state.operations.forEach((op, index) => {
                const operators = {
                    'add': '+',
                    'subtract': '-',
                    'multiply': '*',
                    'divide': '/'
                };

                expression += ` ${operators[op.operation]} ${op.value}`;

                if (isNumeric) {
                    const opValue = parseFloat(op.value);
                    if (!isNaN(opValue)) {
                        switch (op.operation) {
                            case 'add':
                                numericResult += opValue;
                                break;
                            case 'subtract':
                                numericResult -= opValue;
                                break;
                            case 'multiply':
                                numericResult *= opValue;
                                break;
                            case 'divide':
                                numericResult /= opValue;
                                break;
                        }
                    } else {
                        isNumeric = false;
                    }
                }
            });

            return isNumeric ? numericResult : expression;
        }

        // 显示结果
        function displayResult(result) {
            const outputResult = document.getElementById('outputResult');
            const outputStatus = document.getElementById('outputStatus');

            outputResult.classList.remove('calculating');

            // 格式化结果显示
            let formattedResult = result;
            if (typeof result === 'number') {
                if (Number.isInteger(result)) {
                    formattedResult = result.toString();
                } else {
                    formattedResult = result.toFixed(4).replace(/\.?0+$/, '');
                }
            }

            outputResult.innerHTML = `<span style="color: #28a745;">${formattedResult}</span>`;
            outputStatus.textContent = '计算完成';
            outputStatus.className = 'status-badge complete';

            // 禁用所有操作按钮
            document.querySelectorAll('.action-btn').forEach(btn => {
                if (btn.id !== 'resetBtn') {
                    btn.disabled = true;
                }
            });

            // 完成所有步骤指示器
            for (let i = 1; i <= state.maxSteps; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
                document.getElementById(`step${i}`).textContent = `步骤 ${i} ✓`;
            }
        }

        // 添加到历史记录
        function addToHistory(result) {
            const historyList = document.getElementById('historyList');

            // 清除空状态提示
            if (historyList.querySelector('.empty-state')) {
                historyList.innerHTML = '';
            }

            // 创建历史记录项
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';

            let expression = state.currentValue;
            state.operations.forEach(op => {
                const operators = {
                    'add': '+',
                    'subtract': '-',
                    'multiply': '×',
                    'divide': '÷'
                };
                expression += ` ${operators[op.operation]} ${op.value}`;
            });

            historyItem.innerHTML = `
                <span class="history-step">${state.maxSteps}步运算</span>
                <span class="history-expression">${expression}</span>
                <span class="history-result">= ${result}</span>
            `;

            historyList.insertBefore(historyItem, historyList.firstChild);
        }

        // 更新输入状态
        function updateInputStatus(status) {
            document.getElementById('inputStatus').textContent = status;
        }

        // 重置所有状态
        function resetAll() {
            // 重置状态
            state.currentValue = null;
            state.currentStep = 1;
            state.operations = [];
            state.isProcessing = false;

            // 重置UI
            document.getElementById('inputValue').value = '';
            document.getElementById('inputStatus').textContent = '初始值';
            document.getElementById('operationDisplay').textContent = '等待第一步操作...';
            document.getElementById('outputResult').innerHTML = '<span style="color: #999;">等待计算结果...</span>';
            document.getElementById('outputStatus').textContent = '准备就绪';
            document.getElementById('outputStatus').className = 'status-badge ready';
            document.getElementById('nextStepBtn').style.display = 'block';
            document.getElementById('nextStepBtn').disabled = true;
            document.getElementById('calculateBtn').disabled = true;

            // 重置步骤指示器
            for (let i = 1; i <= state.maxSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('active', 'completed');
                stepElement.textContent = `步骤 ${i}`;
            }

            // 重置进度条
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('stepCounter').textContent = '步骤 1/3';

            // 清除操作按钮高亮
            document.querySelectorAll('.operation-btn').forEach(btn => btn.classList.remove('active'));

            // 清除历史记录
            document.getElementById('historyList').innerHTML = '<div class="empty-state">暂无操作记录</div>';
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.zIndex = '2000';
            errorDiv.style.maxWidth = '400px';

            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(errorDiv)) {
                        document.body.removeChild(errorDiv);
                    }
                }, 300);
            }, 3000);
        }

        // 回车键支持
        document.getElementById('inputValue').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !state.currentValue) {
                state.currentValue = this.value.trim();
                updateInputStatus('已设置');
            }
        });

        document.getElementById('modalInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmOperation();
            }
        });

        // 点击模态框外部关闭
        document.getElementById('operationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // 初始化
        updateStepIndicator();
    </script>
</body>
</html>