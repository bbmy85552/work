<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代数函数构建器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #fff8dc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .pipe-container {
            position: relative;
            width: 100%;
            height: 120px;
            background: linear-gradient(90deg, #1e88e5 0%, #42a5f5 100%);
            border-radius: 60px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .pipe-arrow {
            position: absolute;
            top: 50%;
            left: 10%;
            transform: translateY(-50%);
            width: 80%;
            height: 3px;
            background: repeating-linear-gradient(
                to right,
                rgba(255, 255, 255, 0.8),
                rgba(255, 255, 255, 0.8) 12px,
                transparent 12px,
                transparent 20px
            );
            animation: flow 2s linear infinite;
        }

        @keyframes flow {
            0% { transform: translateY(-50%) translateX(0); }
            100% { transform: translateY(-50%) translateX(20px); }
        }

        .number-btn, .variable-btn {
            width: 60px;
            height: 60px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .number-btn:hover, .variable-btn:hover {
            background-color: #f5f5f5;
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .number-btn.active, .variable-btn.active {
            background-color: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .operation-card {
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: grab;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .operation-card:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .operation-card.add {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .operation-card.subtract {
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }

        .operation-card.multiply {
            background: linear-gradient(135deg, #e91e63, #c2185b);
        }

        .operation-card.divide {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .expression-display {
            min-height: 80px;
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .drag-over {
            background-color: rgba(25, 118, 210, 0.1);
            border-color: #1976d2;
        }

        .scroll-btn {
            width: 40px;
            height: 30px;
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .scroll-btn:hover {
            background-color: #e0e0e0;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background-color: transparent;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        .play-btn {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .play-btn i {
            color: #1976d2;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-6 min-h-screen flex flex-col">
        <!-- 顶部标题区域 -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">代数函数构建器</h1>
            <p class="text-gray-600">拖拽运算卡片或手动输入来构建代数表达式</p>
        </div>

        <!-- 主内容区域 -->
        <div class="flex flex-1 gap-6 mb-6">
            <!-- 左侧：输入区域 -->
            <div class="w-48 flex flex-col">
                <!-- 输入方式选择标签 -->
                <div class="flex mb-4 bg-gray-100 rounded-lg p-1">
                    <button class="tab-btn active" onclick="switchInputType('number')">数字</button>
                    <button class="tab-btn" onclick="switchInputType('variable')">变量</button>
                    <button class="tab-btn" onclick="switchInputType('custom')">自定义</button>
                </div>

                <!-- 数字输入区 -->
                <div id="numberInput" class="flex-1 flex flex-col">
                    <div class="scroll-btn rounded-t-lg">
                        <i class="fas fa-chevron-up text-gray-600"></i>
                    </div>
                    <div class="flex-1 bg-white rounded-lg border-2 border-gray-200 p-3 overflow-y-auto">
                        <div class="grid grid-cols-2 gap-2">
                            <button class="number-btn" onclick="selectInput('0')">0</button>
                            <button class="number-btn" onclick="selectInput('1')">1</button>
                            <button class="number-btn" onclick="selectInput('2')">2</button>
                            <button class="number-btn" onclick="selectInput('3')">3</button>
                            <button class="number-btn" onclick="selectInput('4')">4</button>
                            <button class="number-btn" onclick="selectInput('5')">5</button>
                            <button class="number-btn" onclick="selectInput('6')">6</button>
                            <button class="number-btn" onclick="selectInput('7')">7</button>
                            <button class="number-btn" onclick="selectInput('8')">8</button>
                            <button class="number-btn" onclick="selectInput('9')">9</button>
                            <button class="number-btn" onclick="selectInput('-1')">-1</button>
                            <button class="number-btn" onclick="selectInput('-2')">-2</button>
                        </div>
                    </div>
                    <div class="scroll-btn rounded-b-lg">
                        <i class="fas fa-chevron-down text-gray-600"></i>
                    </div>
                </div>

                <!-- 变量输入区 -->
                <div id="variableInput" class="flex-1 flex flex-col hidden">
                    <div class="scroll-btn rounded-t-lg">
                        <i class="fas fa-chevron-up text-gray-600"></i>
                    </div>
                    <div class="flex-1 bg-white rounded-lg border-2 border-gray-200 p-3 overflow-y-auto">
                        <div class="grid grid-cols-2 gap-2">
                            <button class="variable-btn" onclick="selectInput('X')">X</button>
                            <button class="variable-btn" onclick="selectInput('A')">A</button>
                            <button class="variable-btn" onclick="selectInput('B')">B</button>
                            <button class="variable-btn" onclick="selectInput('C')">C</button>
                            <button class="variable-btn" onclick="selectInput('Y')">Y</button>
                            <button class="variable-btn" onclick="selectInput('Z')">Z</button>
                        </div>
                    </div>
                    <div class="scroll-btn rounded-b-lg">
                        <i class="fas fa-chevron-down text-gray-600"></i>
                    </div>
                </div>

                <!-- 自定义输入区 -->
                <div id="customInput" class="flex-1 hidden">
                    <div class="bg-white rounded-lg border-2 border-gray-200 p-4">
                        <input type="text" class="input-field" placeholder="输入数字、分数或变量..."
                               id="customInputField" onkeyup="handleCustomInput(event)">
                        <div class="mt-3 text-sm text-gray-600">
                            <p>支持格式：</p>
                            <p>• 数字：3, -5, 2.5</p>
                            <p>• 分数：1/2, -3/4</p>
                            <p>• 变量：X, A, B, C</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中间：处理区域 -->
            <div class="flex-1 flex flex-col gap-4">
                <!-- 管道可视化区域 -->
                <div class="pipe-container">
                    <div class="pipe-arrow"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="play-btn" onclick="calculateResult()">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>

                <!-- 表达式构建区域 -->
                <div class="bg-white rounded-xl border-3 border-gray-200 p-4 shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">表达式构建区</h3>
                    <div id="expressionArea"
                         class="expression-display min-h-[100px] border-dashed"
                         ondrop="handleDrop(event)"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <span class="text-gray-400">拖拽运算卡片到这里或手动输入</span>
                    </div>

                    <!-- 手动输入区域 -->
                    <div class="mt-4 flex gap-2">
                        <input type="text"
                               id="manualExpression"
                               class="input-field flex-1"
                               placeholder="或手动输入表达式，如：X + 2 * 3"
                               onkeyup="handleManualExpression(event)">
                        <button onclick="setExpressionFromInput()"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                            设置表达式
                        </button>
                    </div>
                </div>

                <!-- 运算卡片区域 -->
                <div class="bg-white rounded-xl border-2 border-gray-200 p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">运算卡片</h3>
                    <div class="flex flex-wrap gap-3 justify-center">
                        <div class="operation-card add" draggable="true" ondragstart="handleDragStart(event, '+', 1)">
                            <i class="fas fa-plus mr-2"></i>1
                        </div>
                        <div class="operation-card subtract" draggable="true" ondragstart="handleDragStart(event, '-', 1)">
                            <i class="fas fa-minus mr-2"></i>1
                        </div>
                        <div class="operation-card multiply" draggable="true" ondragstart="handleDragStart(event, '*', 2)">
                            <i class="fas fa-times mr-2"></i>2
                        </div>
                        <div class="operation-card divide" draggable="true" ondragstart="handleDragStart(event, '/', 2)">
                            <i class="fas fa-divide mr-2"></i>2
                        </div>
                        <div class="operation-card add" draggable="true" ondragstart="handleDragStart(event, '+', 3)">
                            <i class="fas fa-plus mr-2"></i>3
                        </div>
                        <div class="operation-card subtract" draggable="true" ondragstart="handleDragStart(event, '-', 3)">
                            <i class="fas fa-minus mr-2"></i>3
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：输出区域 -->
            <div class="w-48 flex flex-col">
                <div class="scroll-btn rounded-t-lg">
                    <i class="fas fa-chevron-up text-gray-600"></i>
                </div>
                <div class="flex-1 bg-white rounded-lg border-2 border-gray-200 p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">计算结果</h3>
                    <div id="resultDisplay" class="expression-display">
                        <span class="text-gray-400">等待计算...</span>
                    </div>

                    <!-- 变量赋值区域 -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-600 mb-2">变量赋值</h4>
                        <div id="variableAssignments" class="space-y-2">
                            <!-- 动态生成变量赋值输入框 -->
                        </div>
                    </div>
                </div>
                <div class="scroll-btn rounded-b-lg">
                    <i class="fas fa-chevron-down text-gray-600"></i>
                </div>
            </div>
        </div>

        <!-- 底部控制区域 -->
        <div class="flex items-center justify-between py-4 bg-white rounded-xl border-2 border-gray-200 px-6">
            <!-- 左侧：选项 -->
            <div class="flex items-center space-x-4">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" class="mr-2 w-4 h-4 text-blue-600" checked>
                    <span class="text-sm text-gray-700">显示步骤</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" class="mr-2 w-4 h-4 text-blue-600">
                    <span class="text-sm text-gray-700">简化分数</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" class="mr-2 w-4 h-4 text-blue-600" checked>
                    <span class="text-sm text-gray-700">实时计算</span>
                </label>
            </div>

            <!-- 中间：控制按钮 -->
            <div class="flex items-center space-x-3">
                <button onclick="clearExpression()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition flex items-center">
                    <i class="fas fa-eraser mr-2"></i>清空
                </button>
                <button onclick="resetAll()"
                        class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition flex items-center">
                    <i class="fas fa-redo mr-2"></i>重置
                </button>
                <button onclick="saveExpression()"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center">
                    <i class="fas fa-save mr-2"></i>保存
                </button>
            </div>

            <!-- 右侧：帮助 -->
            <button onclick="showHelp()"
                    class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition">
                <i class="fas fa-question-circle text-xl"></i>
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let currentInput = '';
        let expression = [];
        let variables = new Set();
        let draggedOperation = null;

        // 切换输入类型
        function switchInputType(type) {
            // 隐藏所有输入区域
            document.getElementById('numberInput').classList.add('hidden');
            document.getElementById('variableInput').classList.add('hidden');
            document.getElementById('customInput').classList.add('hidden');

            // 移除所有标签的active类
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 显示选中的输入区域并设置active标签
            event.target.classList.add('active');
            document.getElementById(type + 'Input').classList.remove('hidden');
        }

        // 选择输入值
        function selectInput(value) {
            currentInput = value;

            // 更新按钮状态
            if (event.target.classList.contains('number-btn')) {
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            } else {
                document.querySelectorAll('.variable-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            event.target.classList.add('active');

            // 如果开启了实时计算，立即计算
            if (document.querySelector('input[type="checkbox"]:checked')) {
                calculateResult();
            }
        }

        // 处理自定义输入
        function handleCustomInput(event) {
            if (event.key === 'Enter') {
                const value = event.target.value.trim();
                if (value) {
                    currentInput = value;
                    calculateResult();
                }
            }
        }

        // 拖拽开始
        function handleDragStart(event, operation, value) {
            draggedOperation = { operation, value };
            event.dataTransfer.effectAllowed = 'copy';
        }

        // 拖拽经过
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
            document.getElementById('expressionArea').classList.add('drag-over');
        }

        // 拖拽离开
        function handleDragLeave(event) {
            document.getElementById('expressionArea').classList.remove('drag-over');
        }

        // 处理放置
        function handleDrop(event) {
            event.preventDefault();
            document.getElementById('expressionArea').classList.remove('drag-over');

            if (draggedOperation) {
                expression.push(draggedOperation);
                updateExpressionDisplay();
                draggedOperation = null;

                // 如果开启了实时计算，立即计算
                if (document.querySelector('input[type="checkbox"]:checked')) {
                    calculateResult();
                }
            }
        }

        // 处理手动输入表达式
        function handleManualExpression(event) {
            if (event.key === 'Enter') {
                setExpressionFromInput();
            }
        }

        // 设置表达式
        function setExpressionFromInput() {
            const input = document.getElementById('manualExpression').value.trim();
            if (input) {
                // 这里简化处理，实际应该解析表达式
                expression = [{ operation: 'custom', value: input }];
                updateExpressionDisplay();
                calculateResult();
            }
        }

        // 更新表达式显示
        function updateExpressionDisplay() {
            const displayArea = document.getElementById('expressionArea');
            if (expression.length === 0) {
                displayArea.innerHTML = '<span class="text-gray-400">拖拽运算卡片到这里或手动输入</span>';
            } else {
                const exprText = expression.map(op => {
                    if (op.operation === 'custom') {
                        return op.value;
                    }
                    return `${op.operation}${op.value}`;
                }).join(' ');
                displayArea.innerHTML = `<span class="text-blue-600">${currentInput || 'X'}</span> ${exprText}`;
            }
        }

        // 计算结果
        function calculateResult() {
            if (!currentInput && expression.length === 0) {
                document.getElementById('resultDisplay').innerHTML = '<span class="text-gray-400">请输入值并构建表达式</span>';
                return;
            }

            try {
                // 简化的计算逻辑
                let result = currentInput || 'X';
                let exprText = result;

                expression.forEach(op => {
                    if (op.operation === 'custom') {
                        exprText += ' ' + op.value;
                    } else {
                        exprText += ` ${op.operation}${op.value}`;
                        if (typeof result === 'number') {
                            switch (op.operation) {
                                case '+': result += op.value; break;
                                case '-': result -= op.value; break;
                                case '*': result *= op.value; break;
                                case '/': result /= op.value; break;
                            }
                        }
                    }
                });

                // 显示结果
                const resultDisplay = document.getElementById('resultDisplay');
                if (typeof result === 'number') {
                    resultDisplay.innerHTML = `<span class="text-green-600 font-bold text-2xl">${result}</span>`;
                } else {
                    resultDisplay.innerHTML = `<span class="text-blue-600 font-bold text-2xl">${exprText}</span>`;
                }

                // 如果表达式包含变量，显示变量赋值区域
                updateVariableAssignments();

            } catch (error) {
                document.getElementById('resultDisplay').innerHTML = '<span class="text-red-600">计算错误</span>';
            }
        }

        // 更新变量赋值区域
        function updateVariableAssignments() {
            const container = document.getElementById('variableAssignments');
            variables.clear();

            // 从表达式中提取变量
            if (currentInput && /[A-Za-z]/.test(currentInput)) {
                variables.add(currentInput);
            }

            expression.forEach(op => {
                if (op.value && /[A-Za-z]/.test(op.value)) {
                    variables.add(op.value);
                }
            });

            if (variables.size > 0) {
                container.innerHTML = Array.from(variables).map(variable => `
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium">${variable} =</label>
                        <input type="number" class="flex-1 px-2 py-1 border rounded"
                               placeholder="0" onchange="calculateResult()">
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-sm text-gray-500">无变量</p>';
            }
        }

        // 清空表达式
        function clearExpression() {
            expression = [];
            updateExpressionDisplay();
            document.getElementById('manualExpression').value = '';
        }

        // 重置所有
        function resetAll() {
            currentInput = '';
            expression = [];
            variables.clear();
            updateExpressionDisplay();
            document.getElementById('manualExpression').value = '';
            document.getElementById('resultDisplay').innerHTML = '<span class="text-gray-400">等待计算...</span>';
            document.getElementById('variableAssignments').innerHTML = '<p class="text-sm text-gray-500">无变量</p>';

            // 清除所有按钮的active状态
            document.querySelectorAll('.number-btn, .variable-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // 保存表达式
        function saveExpression() {
            const data = {
                input: currentInput,
                expression: expression,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('algebraExpression', JSON.stringify(data));
            alert('表达式已保存！');
        }

        // 显示帮助
        function showHelp() {
            alert('代数函数构建器使用说明：\n\n1. 选择输入值（数字、变量或自定义）\n2. 拖拽运算卡片到表达式构建区\n3. 点击播放按钮查看计算结果\n4. 可以手动输入表达式\n5. 支持变量赋值计算');
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateExpressionDisplay();
        });
    </script>
</body>
</html>